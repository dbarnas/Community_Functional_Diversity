---
title: "Community vs SGD Regression"
author: "Danielle Barnas"
date: "2022-10-14"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE, warning = F}
knitr::opts_chunk$set(echo = TRUE)
```

# Load Libraries
```{r}
library(tidyverse)
library(here)
library(ggrepel)
library(PNWColors)
library(vegan)
library(pairwiseAdonis)
```


# Read in data
```{r, message = F}
div <- read_csv(here("Data","Surveys","Species_Diversity.csv"))
rich <- read_csv(here("Data","Surveys","Species_Richness.csv"))
turb <- read_csv(here("Data", "Biogeochem", "July2022", "Turb_NC.csv"))
meta <- read_csv(here("Data", "Full_Metadata.csv"))
sub <- read_csv(here("Data","Surveys","Substrate_2022.csv"))
comp <- read_csv(here("Data","Surveys","Species_Composition_2022.csv"))
taxa <- read_csv(here("Data","Surveys","Distinct_Taxa.csv"))

# create color palette for plotting
mypalette <- pnw_palette(name="Bay")
largepalette <- pnw_palette(name = "Bay", n = 100)
```


# Process and Join data
```{r}
# calculate %cover of substrates
sub <- sub %>%
  group_by(Location, CowTagID) %>%
  mutate(TotalSub = sum(LiveCoral, DeadCoral, Rubble, Sand)) %>%
  mutate_at(.vars = vars(LiveCoral:Sand), .funs = ~(. / TotalSub *100)) %>% # ~ and . allow the function to run across all variables
  select(-c(Date, TotalSub))

# join dfs
Full_data <- div %>%
  full_join(rich) %>% 
  full_join(turb) %>%
  full_join(meta) %>%
  full_join(sub) %>%
  drop_na() # remove incomplete datasets (for now, just varari w/o V13)

comp <- comp %>% 
  select(Location, CowTagID, Taxa, SpeciesCounts) %>% 
  group_by(Location, CowTagID) %>% 
  mutate(totalcount = sum(SpeciesCounts),
         sp_percent = SpeciesCounts / totalcount*100) %>% 
  select(-totalcount) %>% 
  filter(Location == "Varari") %>% 
  left_join(turb)
  

```

# Functions

## Create function to order cowtagID's when plotting
```{r}
order <- function(data = Full_data, param, by){

  param<- enquo(param)
  by<- enquo(by)
  
  orderParam <- data %>%
     arrange(!!param) %>%
     distinct(!!by) %>% 
     mutate(CowTagID = as_factor(as.character(!!by)))

  # sort factor levels by N_percent
  ParamLevels <- paste(orderParam$CowTagID)
  # assign order to factor levels by % N
  data$CowTagID <- factor(data$CowTagID, levels = ParamLevels)
  # levels(data$CowTagID) # check

return(data)
}

## test
order(param = N_percent, by = CowTagID)$CowTagID
order(param = dist_to_seep_m, by = CowTagID)$CowTagID
```

## relationships between substrate, nutrients, and metadata

### Create function for geom_point plots with facet_wrapping
```{r}

# create ggplot function
groupplot <- function(mydata = Full_data, x, y, fw) {

  x<-enquo(x)
  y<-enquo(y)

  plot <- ggplot(data = mydata,
                 aes(y = !!y,
                     x = !!x,
                     color = !!enquo(fw))) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(enquo(fw), scales = "free_y") +
  labs(y = paste(as_label(y)),
       x = paste(as_label(x))) +
  theme_bw()+
  theme(legend.direction = "horizontal",
        legend.position = "top") +
  scale_color_manual(values = mypalette)
  
  return(plot)
}
```

### Create function for geom_col stacked
```{r}

# create ggplot function
stackplot <- function(mydata, x = CowTagID, y, colfill) {

  x<-enquo(x)
  y<-enquo(y)

  plot <- ggplot(data = mydata,
                 aes(y = !!y,
                     x = !!x,
                     fill = !!enquo(colfill))) +
  geom_col(position = "stack") +
  labs(y = paste(as_label(y)),
       x = paste(as_label(x))) +
  theme_bw()+
  theme(legend.position = "right") +
  scale_fill_manual(values = mypalette)
  
  return(plot)
}
```



## Plotting

### Substrate ~ % N
```{r}

# pivot longer by categories
longsub<- Full_data %>% 
  select(-c(lat, lon)) %>%  
  pivot_longer(cols = c(LiveCoral:Sand), names_to = "Substrate", values_to = "subVal")

groupplot(mydata = longsub, x = N_percent, y = subVal, fw = Substrate) +
  labs(x = "% Nitrogen", y = "% Cover of Substrate Type")

# %N and substrate type
summary(lm(data = Full_data, Sand ~ N_percent))
summary(lm(data = Full_data, Rubble ~ N_percent))
summary(lm(data = Full_data, LiveCoral ~ N_percent))
summary(lm(data = Full_data, DeadCoral ~ N_percent))
```

### Diversity ~ Richness
```{r}
## DIVERSITY VS RICHNESS

groupplot(mydata = Full_data, x = ShannonDivSpecies, y = spRichness, fw = NA)

summary(lm(data = Full_data, ShannonDivSpecies ~ spRichness))
```

### Species metric ~ distance to seep
```{r}
## DISTANCE TO SEEP
longspecies<-Full_data %>% 
  pivot_longer(cols = c(ShannonDivSpecies, spRichness), names_to = "Metric", values_to = "SpeciesVal")

groupplot(mydata = longspecies, x = dist_to_seep_m, y = SpeciesVal, fw = Metric) +
    geom_text_repel(aes(label = CowTagID), size = 3)
  
longspecies %>% filter(CowTagID == "V16")
```

## Regression models
```{r, eval = F}
summary(lm(data = Full_data, ShannonDivSpecies ~ N_percent))
summary(lm(data = Full_data, ShannonDivSpecies ~ del15N))
summary(lm(data = Full_data, ShannonDivSpecies ~ C_N))

summary(lm(data = Full_data, spRichness ~ N_percent))
summary(lm(data = Full_data, spRichness ~ del15N))
summary(lm(data = Full_data, spRichness ~ C_N))

summary(lm(data = Full_data, spRichness ~ N_percent * del15N * C_N))
summary(lm(data = Full_data, ShannonDivSpecies ~ N_percent * del15N * C_N))

summary(lm(data = Full_data, spRichness ~ Sand)) # significant
summary(lm(data = Full_data, spRichness ~ N_percent * Sand))

summary(lm(data = Full_data, ShannonDivSpecies ~ Sand)) # significant
summary(lm(data = Full_data, ShannonDivSpecies ~ N_percent * Sand))

summary(lm(data = Full_data, spRichness ~ meanRugosity)) # significant
summary(lm(data = Full_data, ShannonDivSpecies ~ meanRugosity)) # significant

summary(lm(data = Full_data, meanRugosity ~ dist_to_seep_m))
summary(lm(data = Full_data, spRichness ~ dist_to_seep_m)) # significant
summary(lm(data = Full_data, ShannonDivSpecies ~ dist_to_seep_m)) # significant

summary(lm(data = Full_data, ShannonDivSpecies ~ spRichness)) # significant

summary(lm(data = Full_data, N_percent ~ dist_to_seep_m)) 
summary(lm(data = Full_data, C_N ~ dist_to_seep_m)) 
summary(lm(data = Full_data, del15N ~ dist_to_seep_m)) 

```

## Plotting stacked % cover

### Plotting % Cover substrate ~ % N
```{r}

# order % cover by N_percent
order(data = longsub, param = N_percent, by = CowTagID)$CowTagID

# ggplot
stackplot(mydata = longsub, x = CowTagID, y = subVal, colfill = Substrate) +
  labs(subtitle = "Low to High %N")
```

### Plotting % Cover species ~ % N
```{r}

# order % cover by N_percent
order(data = comp, param = N_percent, by = CowTagID)$CowTagID

# ggplot
stackplot(mydata = comp, x = CowTagID, y = sp_percent, colfill = Taxa) +
  labs(subtitle = "Low to High %N") +
  scale_fill_manual(values = largepalette) +
  theme(legend.text = element_text(size = 2))
```


# Presence-Absence Analysis
```{r}
spPA <- taxa %>% 
  count(Taxa, name = "presence") %>% 
  right_join(comp) %>% 
  select(Taxa, presence, CowTagID) %>% 
  pivot_wider(names_from = Taxa, values_from = presence) %>%  # extend out to establish NAs
  pivot_longer(names_to = "Taxa", values_to = "presence", cols = 2:62) %>%  #long form to turn NAs into 0's for absence
  mutate(presence = if_else(is.na(presence), 0, 1)) # presence-absence of species per CowTagID

genPA <- taxa %>% 
  right_join(comp) %>% 
  drop_na(Genus) %>% 
  group_by(CowTagID) %>% 
  count(Genus, name = "presence") %>%
  pivot_wider(names_from = Genus, values_from = presence) %>%  # extend out to establish NAs
  pivot_longer(names_to = "Genus", values_to = "presence", cols = 2:32) %>%  #long form to turn NAs into 0's for absence
  mutate(presence = if_else(is.na(presence), 0, 1)) # presence-absence of species per CowTagID
```


# PCA and Permanova: survey location characteristics

## PCA
```{r}
# extract parameters for the PCA, excluding CT depth
pca_fulldata <- Full_data %>% 
  select(-c(CowTagID,Location,lat,lon, adj_CT_depth_cm, dist_to_seep_m))

# Run the PCA
pca_full <- prcomp(pca_fulldata, scale. = TRUE, center = TRUE)

# Extract the scores and loadings
PC_scores_full <-as_tibble(pca_full$x[,1:2])
PC_loadings_full<-as_tibble(pca_full$rotation) %>%
  bind_cols(labels = rownames(pca_full$rotation))

# Put it with all the original data
pca_fulldata_all<-Full_data %>%
  bind_cols(PC_scores_full)

```

## scores plot
```{r}
p1_full<-pca_fulldata_all %>%
  ggplot(aes(x = PC1, 
             y = PC2 
             #fill = V_cluster
             ))+
  geom_point(shape = 21,
             color = "white",
             fill = "white",
             size = 3) +
  #coord_cartesian(xlim = c(-4, 7), ylim = c(-6, 4)) +
  #scale_shape_manual(values = c(22,16))+
  scale_colour_hue(l = 45)+ # l: luminance/lightness 0-100
  scale_fill_hue(l = 45)+ 
  #scale_fill_manual(values = mypalette) +
  # ggforce::geom_mark_ellipse(
  #   aes(fill = V_cluster, label = V_cluster), 
  #   alpha = .15, show.legend = FALSE,  label.buffer = unit(1, "mm"))+
  theme_bw()+
  theme(legend.position = "none", panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(title = "Varari Scores Plot") +
  geom_text_repel(aes(label = CowTagID))

p1_full
```

## loadings plot
```{r}
# loadings plot 
p1_full_loading <- PC_loadings_full %>%
  ggplot(aes(x = PC1, y = PC1, label = labels)) + # labels are the parameters
    geom_segment(aes(x = 0,
                     y = 0,
                     xend = PC1*10,
                     yend = PC2*10),
      arrow = arrow(length = unit(0.1,"cm")), 
      color = "grey") +
  annotate("text", 
           x = PC_loadings_full$PC1*10+0.5, 
           y = PC_loadings_full$PC2*10+0.5,
           label = PC_loadings_full$labels) +
  coord_cartesian(xlim = c(-6, 6), ylim = c(-6, 6)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  labs(title = "Varari Loadings")
p1_full_loading
```

```{r, eval = F}
### Patch PCA plots
VarariPCA <- p1_full + p1_full_loading + 
  patchwork::plot_annotation("Varari PCA and Loadings", 
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))

ggsave(plot = VarariPCA, filename = here("Output","VarariPCA_rich_div_meta.png"), width = 14, height = 6)

```

## nMDS Plot
### Prep data
```{r}
# create ordination output using bray curtis dissimilarity matrix
# remove non-numerical data
# distance = is the type of dissimilarity matrix
# k is number of dimensions (you can try different ones to look at different stress)
CTlevels <- c('V1','V2','V3','V4','V5','V6','V7','V8','V9','V10','V11','V12','V14','V15','V16','V17','V18','V19','V20')

richPerm <- Full_data %>%
  select(-c(Location, adj_CT_depth_cm, dist_to_seep_m))
richPerm$CowTagID <- factor(richPerm$CowTagID, levels = CTlevels)
richPerm <- richPerm %>% 
  arrange(CowTagID) %>% # arrange data in order of CowTagID for ordination plot later
  select(-c(CowTagID, ShannonDivSpecies, lat, lon))

richOrd <- metaMDS(richPerm, k=3, distance='bray') 

# stress with k=2 dimensions. Is it < 0.3? 
richOrd$stress

# stress plot
# want to minimize scatter
stressplot(richOrd)
```

### Plot nMDS ordinations
```{r}
## ggplot

#summary(richOrd)

# get points for site characteristics
richRow <- rownames(richOrd$species) # get characteristic names
richMDS1 <- c(richOrd$species[1:10]) # MDS1 for characteristics
richMDS2 <- c(richOrd$species[11:20]) # MDS2 for characteristics
richData <- as_tibble(cbind(richRow, richMDS1, richMDS2)) %>%  # bind all cols into tibble
  mutate(richMDS1 = as.numeric(richMDS1), # as numeric 
         richMDS2 = as.numeric(richMDS2))
# get points for CowTagIDs
richRowb <- as.character(CTlevels) # assign CowTagID names
richMDS1b <- c(richOrd$points[1:19]) # MDS1 for CowTagID
richMDS2b <- c(richOrd$species[11:20]) # MDS2 for CowTagID
richDatab <- as_tibble(cbind(richRowb, richMDS1b, richMDS2b)) %>%  # bind all cols into tibble
  mutate(richMDS1b = as.numeric(richMDS1b), # as numeric 
         richMDS2b = as.numeric(richMDS2b))

# plotting
nMDSplot <- ggplot(data = richData, # sit characteristics
       aes(x = richMDS1,
           y = richMDS2)) +
  geom_point(color = "red", shape = 2) +
  geom_point(data = richDatab, # CowTagIDs
             aes(x = richMDS1b,
                 y = richMDS2b),
             color = "black") +
  geom_text_repel(data = richData, # site characteristics
                  aes(x = richMDS1,
                      y = richMDS2,
                      label = richRow),
                  size = 3) +
  geom_text_repel(data = richDatab, # CowTagIDs
                  aes(x = richMDS1b,
                      y = richMDS2b,
                      label = richRowb),
                  size = 3) +
  theme_bw() +
  theme(panel.grid = element_blank())

nMDSplot
#ggsave(here("Output","nMDS_Varari.png"), nMDSplot, width = 14, height = 9)
```

## PERMANOVA
```{r, echo = F, eval = F}
#We could formally test whether locations are different using a perMANOVA. 
#This requires the adonis command in the vegan package
richPermFull <- cbind(richRowb, richPerm) %>%  # bind cowTagIDs
  rename(CowTagID = richRowb)

permanovamodel<-adonis2(richPermFull[,-c(1:2)]~CowTagID, richPermFull, permutations = 999, 
                       method="bray") # should change out cowtagid with some grouping name
permanovamodel

#If we are to trust the results of the permanova, then we have to assume that the dispersion among
#data is the same in each group. We can test with assumption with a PermDisp test:
disper<-vegdist(richPermFull[,-c(1:2)])
betadisper(disper, richPermFull$CowTagID)
#Look at the Average distance to median...these numbers should be reasonably similar
#A rule of thumb is that one number should not be twice as high as any other

pairwise.adonis(PercentTotal[-1], PercentTotal$Site, perm=999)

#Get coefficients to see which species are most important in explaining site differences:
permanovamodel$coefficients

```

## Species metrics regrssion against all site characteristics
```{r}
Full_data %>% 
  select(-c(lat, lon, adj_CT_depth_cm, Location)) %>% 
  pivot_longer(cols = del15N:Sand, names_to = "Parameters", values_to = "Values") %>% 
  ggplot(aes(x = Values, y = spRichness,
             label = CowTagID)) +
  geom_point() +
  geom_smooth(method = "lm", color = "black") +
  geom_text_repel(size = 2) +
  theme_bw() +
  facet_wrap(~Parameters, scales = "free_x")
```

```{r}
Full_data %>% 
  select(-c(lat, lon, adj_CT_depth_cm, Location)) %>% 
  pivot_longer(cols = del15N:Sand, names_to = "Parameters", values_to = "Values") %>% 
  ggplot(aes(x = Values, y = ShannonDivSpecies,
             label = CowTagID)) +
  geom_point() +
  geom_smooth(method = "lm", color = "black") +
  geom_text_repel(size = 2) +
  theme_bw() +
  facet_wrap(~Parameters, scales = "free_x")
```

### Species metrics vs Ratio of Sand to hard substrate
```{r}
# Ratio of sand to hard substrate
Full_data %>% 
  select(-c(lat, lon, adj_CT_depth_cm, Location)) %>% 
  mutate(HardSub = LiveCoral + DeadCoral + Rubble,
         log_Sand_HardSub = log(Sand/HardSub)) %>% 
  select(-c(LiveCoral:HardSub)) %>% 
  pivot_longer(cols = del15N:log_Sand_HardSub, names_to = "Parameters", values_to = "Values") %>% 
  ggplot(aes(x = Values, y = spRichness,
             label = CowTagID)) +
  geom_point() +
  geom_smooth(method = "lm", color = "black") +
  geom_text_repel(size = 2, max.overlaps = 15) +
  theme_bw() +
  facet_wrap(~Parameters, scales = "free_x")
```

```{r}
# Ratio of sand to hard substrate
Full_data %>% 
  select(-c(lat, lon, adj_CT_depth_cm, Location)) %>% 
  mutate(HardSub = LiveCoral + DeadCoral + Rubble,
         log_Sand_HardSub = log(Sand/HardSub)) %>% 
  select(-c(LiveCoral:HardSub)) %>% 
  pivot_longer(cols = del15N:log_Sand_HardSub, names_to = "Parameters", values_to = "Values") %>% 
  ggplot(aes(x = Values, y = ShannonDivSpecies,
             label = CowTagID)) +
  geom_point() +
  geom_smooth(method = "lm", color = "black") +
  geom_text_repel(size = 2, max.overlaps = 15) +
  theme_bw() +
  facet_wrap(~Parameters, scales = "free_x")
```


