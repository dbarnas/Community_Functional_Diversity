---
title: "Community vs SGD Regression"
author: "Danielle Barnas"
date: "2022-10-14"
output:
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE, warning = F}
knitr::opts_chunk$set(echo = TRUE)
```

# Install necessary libraries
```{r, eval = F}
if("tidyverse" %in% rownames(installed.packages()) == FALSE){install.packages("tidyverse")}
if("here" %in% rownames(installed.packages()) == FALSE){install.packages("here")}
if("ggrepel" %in% rownames(installed.packages()) == FALSE){install.packages("ggrepel")}
if("PNWColors" %in% rownames(installed.packages()) == FALSE){install.packages("PNWColors")}
if("vegan" %in% rownames(installed.packages()) == FALSE){install.packages("vegan")}
if("pairwiseAdonis" %in% rownames(installed.packages()) == FALSE){ devtools::install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis")}
if("patchwork" %in% rownames(installed.packages()) == FALSE){install.packages("patchwork")}
if("ggmap" %in% rownames(installed.packages()) == FALSE){install.packages("ggmap")}
```


# Load Libraries
```{r}
library(tidyverse)
library(here)
library(ggrepel)
library(PNWColors)
library(vegan)
library(pairwiseAdonis)
library(patchwork)
library(ggmap)

set.seed(7)
```


# Read in data
```{r, message = F}
#div <- read_csv(here("Data","Surveys","Species_Diversity.csv")) # cannot calculate species div with % cover data
rich <- read_csv(here("Data","Surveys","Species_Richness.csv"))
meta <- read_csv(here("Data", "Full_Metadata.csv"))
comp <- read_csv(here("Data","Surveys","Species_Composition_2022.csv"))
taxa <- read_csv(here("Data","Surveys","Distinct_Taxa.csv"))
chem <- read_csv(here("Data","Biogeochem", "Nutrient_Processed_CV.csv"))

# create color palette for plotting
mypalette <- pnw_palette(name="Bay")
midpalette <- pnw_palette(name = "Bay", n = 30)
largepalette <- pnw_palette(name = "Bay", n = 100)
```


# Process and Join data
```{r}
# reduce metadata
meta <- meta %>% 
  drop_na(lat) %>% 
  select(Location, CowTagID, LiveCoral:Sand, dist_to_seep_m, adj_CT_depth_cm, meanRugosity)

# join dfs
Full_data <- rich %>% 
  full_join(chem) %>% 
  drop_na(lat) %>% # remove largely incomplete datasets
  filter(CowTagID != "C14") %>%  # not surveyed
  left_join(meta)


comp <- comp %>% 
  select(Location, CowTagID, Taxa, SpeciesCounts) %>% 
  mutate(Taxa = if_else(Taxa == 'Bare Rock', "Hard Substrate", Taxa),
         Taxa = if_else(Taxa == 'Rubble', "Hard Substrate", Taxa)) %>% 
  group_by(Location, CowTagID, Taxa) %>% 
  mutate(SpeciesCounts = sum(SpeciesCounts)) %>% 
  distinct() %>% 
  ungroup() %>% # ungroup by taxa to regroup by site
  group_by(Location, CowTagID) %>% 
  mutate(totalcount = sum(SpeciesCounts),
         sp_percent = SpeciesCounts / totalcount*100) %>% 
  select(-totalcount) %>% 
  left_join(Full_data) %>% 
  ungroup() %>% 
  filter(Location == "Varari") # only Varari for now

# rearrange
Full_data <- Full_data %>% 
  relocate(Location, .before = CowTagID)

# only Varari for now
Full_data <- Full_data %>% 
  filter(Location == "Varari")

# pivot longer by categories
longsub<- Full_data %>% 
  select(-c(lat, lon)) %>%  
  pivot_longer(cols = c(LiveCoral:Sand), names_to = "Substrate", values_to = "subVal")

```

# Functions

## Create function to order cowtagID's when plotting
```{r}
order <- function(data = Full_data, param, by){

  param<- enquo(param)
  by<- enquo(by)
  
  orderParam <- data %>%
     arrange(!!param) %>%
     distinct(!!by) %>% 
     mutate(CowTagID = as_factor(as.character(!!by)))

  # sort factor levels by N_percent
  ParamLevels <- paste(orderParam$CowTagID)
  # assign order to factor levels by % N
  data$CowTagID <- factor(data$CowTagID, levels = ParamLevels)
  # levels(data$CowTagID) # check

return(data)
}

## test
order(param = N_percent, by = CowTagID)$CowTagID
order(param = dist_to_seep_m, by = CowTagID)$CowTagID
```

## relationships between substrate, nutrients, and metadata

### Create function for geom_point plots with facet_wrapping
```{r}

# create ggplot function
groupplot <- function(mydata = Full_data, x, y, fw) {

  x<-enquo(x)
  y<-enquo(y)

  plot <- ggplot(data = mydata,
                 aes(y = !!y,
                     x = !!x,
                     color = !!enquo(fw))) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(enquo(fw), scales = "free_y") +
  labs(y = paste(as_label(y)),
       x = paste(as_label(x))) +
  theme_bw()+
  theme(legend.direction = "horizontal",
        legend.position = "top")
  
  return(plot)
}
```

### Create function for geom_col stacked
```{r}

# create ggplot function
stackplot <- function(mydata, x = CowTagID, y, colfill) {

  x<-enquo(x)
  y<-enquo(y)

  plot <- ggplot(data = mydata,
                 aes(y = !!y,
                     x = !!x,
                     fill = !!enquo(colfill))) +
  geom_col(position = "stack") +
  labs(y = paste(as_label(y)),
       x = paste(as_label(x))) +
  theme_bw()+
  theme(legend.position = "right")
  
  return(plot)
}
```

### Create function for geom_col facet_wrapped
```{r}

# create ggplot function
colplot <- function(mydata, x = CowTagID, y) {

  x<-enquo(x)
  y<-enquo(y)

  plot <- ggplot(data = mydata,
                 aes(y = !!y,
                     x = !!x)) +
  geom_col() +
  labs(y = paste(as_label(y)),
       x = paste(as_label(x))) +
  theme_bw()+
  theme(legend.position = "none")
  
  return(plot)
}
```



## Plotting

### Substrate ~ % N
```{r}

groupplot(mydata = longsub, x = N_percent, y = subVal, fw = Substrate) +
  labs(x = "% Nitrogen", y = "% Cover of Substrate Type")+
  scale_color_manual(values = mypalette)



# %N and substrate type
# summary(lm(data = Full_data, Sand ~ N_percent))
# summary(lm(data = Full_data, Rubble ~ N_percent))
# summary(lm(data = Full_data, LiveCoral ~ N_percent))
# summary(lm(data = Full_data, DeadCoral ~ N_percent))
```



### All biogeochem ~ distance to seep (excepting V13, upstream)
```{r}
longChem <- Full_data %>% 
  filter(CowTagID != "VSEEP") %>% 
  pivot_longer(cols = c(Salinity:N_percent), values_to = "Values", names_to = "Parameter") 
longChem %>% 
  drop_na(Values, dist_to_seep_m) %>%
  filter(CowTagID != "V13") %>% 
  ggplot(aes(y = Values,
             x = dist_to_seep_m)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_wrap(~Parameter, scales = "free_y") +
  theme_bw()+
  theme(legend.direction = "none") +
  scale_fill_manual(values = largepalette)

Full_data %>% # V18
  filter(Ammonia_umolL == max(Ammonia_umolL)) %>% select(CowTagID, Ammonia_umolL)
Full_data %>% # V17
  filter(pH == min(pH)) %>% select(CowTagID, pH)
Full_data %>% # VSEEP
  filter(Salinity == max(Salinity)) %>% select(CowTagID, Salinity)
Full_data %>% # V17
  filter(Temperature == min(Temperature)) %>% select(CowTagID, Temperature)
```



# Calculate p values for regressions
## ~ Distance, Including Seep
```{r}
Param_data <- Full_data %>% 
  select(Location, CowTagID, Salinity:meanRugosity) %>% 
  relocate(dist_to_seep_m, .before = Salinity) %>% 
  filter(CowTagID != "V13")

Distance_pval <- tibble(Parameter = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric())

for(i in 4:ncol(Param_data)){
  
  Parameter <- colnames(Param_data)[i] # select dependent parameter
  mod <- lm(paste(Parameter, "~", "dist_to_seep_m"), data = Param_data)
  pvalue <- summary(mod)[4]$coefficients[8]
  adj_r_squared <- summary(mod)[9]$adj.r.squared
  
  temp <- as_tibble(cbind(Parameter, pvalue, adj_r_squared)) %>% 
    mutate(pvalue = as.numeric(pvalue),
           adj_r_squared = as.numeric(adj_r_squared))
  
  Distance_pval <- Distance_pval %>% 
    rbind(temp)
}

# view table of pvalues
Distance_pval

# view bar graph of pvalues with 0.05 cutoff
Distance_pval %>% 
  ggplot(aes(x = Parameter, y = pvalue)) +
  geom_col() +
  geom_hline(yintercept = 0.05) +
  theme_bw() +
  labs(y = "p-value: ~ Distance to Seep (m)",
       title = "Including VSEEP") +
  theme(axis.text.x = element_text(angle = 90))
  
```


### Species richness ~ distance to seep
```{r}
## DISTANCE TO SEEP

groupplot(mydata = Full_data %>% filter(CowTagID != "V13"), x = dist_to_seep_m, y = spRichness, fw = NA) +
    geom_text_repel(aes(label = CowTagID), size = 3)+
  scale_color_manual(values = mypalette)

anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ dist_to_seep_m)) # significant ***
```

### Species Richness ~ covariates with distance to seep
```{r}
Rich_Param <- Full_data %>% 
  select(-c(lat, lon)) %>% 
  relocate(dist_to_seep_m, .before = Salinity) %>% 
  filter(CowTagID != "V13") %>% 
  pivot_longer(cols = Salinity:meanRugosity, names_to = "Parameter", values_to = "Values")

anti_dist <- Distance_pval %>% 
  filter(pvalue > 0.05) %>% 
  select(Parameter)

# remove parameters which were not significantly correlated to distance to seep
Rich_Param <- Rich_Param %>% 
  anti_join(anti_dist)


## Plot
# ~ species richness
groupplot(mydata = Rich_Param, y = Values, x = spRichness, fw = Parameter)

# ~ distance to seep
groupplot(mydata = Rich_Param, y = Values, x = dist_to_seep_m, fw = Parameter)

# linear regressions  
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ Temperature)) # significant *
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ TA)) # significant *
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N))
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ DeadCoral)) # significant ***
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ Sand)) # significant ***

anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ Temperature * TA * DeadCoral * Sand)) # Temperature * and TA * ; no interactive effects

```

### Additional regression models
```{r}

anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ N_percent))
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ N_percent * Temperature))
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ N_percent * TA)) # TA *
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ N_percent * DeadCoral)) # DeadCoral ***
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ N_percent * Sand)) # Sand ***
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ N_percent * Temperature * TA * DeadCoral)) # N_percent * and Temperature ** and TA * and DeadCoral ** and N_percent:TA * and N_percent:DeadCoral * and N_percent:Temperature:TA ** ; TA:DeadCoral p = 0.059
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ N_percent * TA * DeadCoral * Sand)) # TA ** and DeadCoral ** and N_percent:DeadCoral * and N_percent:Sand *

anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N))
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N * Temperature))
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N * TA)) # TA *
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N * DeadCoral)) # DeadCoral ***
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N * Sand)) # Sand ***
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N * Temperature * TA * DeadCoral)) # Temperature * and DeadCoral *
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N * TA * DeadCoral * Sand)) # TA * and DeadCoral * and C_N:Sand *
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ C_N * TA * Temperature)) # TA * ; C_N:TA:Temperature p = 0.055

anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ del15N))
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ del15N * Temperature)) # Interaction of del15N:Temperature * ; Temperature p = 0.058
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ del15N * TA)) # TA **
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ del15N * DeadCoral)) # DeadCoral ***
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ del15N * Sand)) # Sand ***
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ del15N * Temperature * TA * DeadCoral)) # Temperature * and TA * and DeadCoral * ; no interactive effects
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), spRichness ~ del15N * TA * DeadCoral * Sand)) # TA ** and DeadCoral * ; no interactive effects

anova(lm(data = Full_data %>% filter(CowTagID != "V13"), C_N ~ TA * Temperature)) # TA **
anova(lm(data = Full_data %>% filter(CowTagID != "V13"), TA ~ Temperature)) # ***

```


## ~ Distance, Excluding Seep
```{r}
Param_data <- Full_data %>% 
  select(Location, CowTagID, Salinity:meanRugosity) %>% 
  relocate(dist_to_seep_m, .before = Salinity) %>% 
  filter(CowTagID != "V13", CowTagID != "VSEEP")

Distance_pval <- tibble(Parameter = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric())

for(i in 4:ncol(Param_data)){
  
  Parameter <- colnames(Param_data)[i] # select dependent parameter
  mod <- lm(paste(Parameter, "~", "dist_to_seep_m"), data = Param_data)
  pvalue <- summary(mod)[4]$coefficients[8]
  adj_r_squared <- summary(mod)[9]$adj.r.squared
  
  temp <- as_tibble(cbind(Parameter, pvalue, adj_r_squared)) %>% 
    mutate(pvalue = as.numeric(pvalue),
           adj_r_squared = as.numeric(adj_r_squared))
  
  Distance_pval <- Distance_pval %>% 
    rbind(temp)
}

# view table of pvalues
Distance_pval

# view bar graph of pvalues with 0.05 cutoff
Distance_pval %>% 
  ggplot(aes(x = Parameter, y = pvalue)) +
  geom_col() +
  geom_hline(yintercept = 0.05) +
  theme_bw() +
  labs(y = "p-value: ~ Distance to Seep (m)",
       title = "Excluding VSEEP") +
  theme(axis.text.x = element_text(angle = 90))
  
```


### Species metric ~ distance to seep
```{r}
## DISTANCE TO SEEP

groupplot(mydata = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), x = dist_to_seep_m, y = spRichness, fw = NA) +
    geom_text_repel(aes(label = CowTagID), size = 3)+
  scale_color_manual(values = mypalette)

anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ dist_to_seep_m)) # **
```

### Species Richness ~ covariates with distance to seep
```{r}
Rich_Param <- Full_data %>% 
  select(-c(lat, lon)) %>% 
  relocate(dist_to_seep_m, .before = Salinity) %>% 
  filter(CowTagID != "V13",
         CowTagID != "VSEEP") %>% 
  pivot_longer(cols = Salinity:meanRugosity, names_to = "Parameter", values_to = "Values")

anti_dist <- Distance_pval %>% 
  filter(pvalue > 0.05) %>% 
  select(Parameter)

# remove parameters which were not significantly correlated to distance to seep
Rich_Param <- Rich_Param %>% 
  anti_join(anti_dist)


## Plot
# ~ species richness
groupplot(mydata = Rich_Param, y = Values, x = spRichness, fw = Parameter)

# ~ distance to seep
groupplot(mydata = Rich_Param, y = Values, x = dist_to_seep_m, fw = Parameter)
  
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ VisibleHumidic_Like)) # *
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ Sand)) # **

anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ Sand * VisibleHumidic_Like)) # Sand *** and VisibleHumidic_Like ** ; no interactive effect

```

### Additional regression models
```{r}

anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ N_percent))
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ N_percent * Sand)) # Sand **
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ N_percent * VisibleHumidic_Like)) # VisibleHumidic_Like **
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ N_percent * Sand * VisibleHumidic_Like)) # Sand *** and VisibleHumidic_Like *** ; N_percent:VisibleHumidic_Like p= 0.056 ; N_percent:VisibleHumidic_Like:Sand p = 0.054

anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ C_N))
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ C_N * Sand)) # Sand **
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ C_N * VisibleHumidic_Like)) # VisibleHumidic_Like **
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ C_N * Sand * VisibleHumidic_Like)) # Sand *** and VisibleHumidic_Like *** and Sand:VisibleHumidic_Like * and C_N:Sand:VisibleHumidic_Like **

anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ del15N))
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ del15N * Sand)) # del15N * and Sand **
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ del15N * VisibleHumidic_Like)) # del15N * and VisibleHumidic_Like **
anova(lm(data = Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"), spRichness ~ del15N * Sand * VisibleHumidic_Like)) # del15N * and Sand *** and VisibleHumidic_Like ** ; no interactive effects
```





## Plotting stacked % cover

### Plotting % Cover substrate ~ % N
```{r}

# order % cover by N_percent
longsub$CowTagID <- order(data = longsub, param = N_percent, by = CowTagID)$CowTagID

# ggplot
stackplot(mydata = longsub, x = CowTagID, y = subVal, colfill = Substrate) +
  labs(subtitle = "Low to High %N") +
  theme(axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values = mypalette)
  
```

### Plotting % Cover species ~ % N
```{r}

# order % cover by N_percent
comp$CowTagID <- order(data = comp, param = N_percent, by = CowTagID)$CowTagID

# ggplot
stackplot(mydata = comp %>% filter(Taxa != "Hard Substrate", Taxa != "Sand"), x = CowTagID, y = sp_percent, colfill = Taxa) +
  labs(subtitle = "Low to High %N") +
  scale_fill_manual(values = largepalette) +
  theme(legend.text = element_text(size = 2),
        axis.text.x = element_text(angle = 90))+
  scale_fill_manual(values = largepalette)
```

### Plotting % Cover species ~ distance to seep
```{r}

# order % cover by N_percent
comp$CowTagID <- order(data = comp, param = dist_to_seep_m, by = CowTagID)$CowTagID

# ggplot
stackplot(mydata = comp %>% filter(Taxa != "Hard Substrate", Taxa != "Sand", CowTagID != "V13"), x = CowTagID, y = sp_percent, colfill = Taxa) +
  labs(subtitle = "Distance from seep (m)") +
  scale_fill_manual(values = largepalette) +
  theme(legend.text = element_text(size = 2),
        axis.text.x = element_text(angle = 90))
```

# Presence-Absence Analysis
```{r}
spPA <- comp %>% 
  select(Location, CowTagID, Taxa, SpeciesCounts) %>% 
  pivot_wider(names_from = Taxa, values_from = SpeciesCounts) %>%  # extend out to establish NAs
  pivot_longer(names_to = "Taxa", values_to = "SpeciesCounts", cols = 3:62) %>%  #long form to turn NAs into 0's for absence
  mutate(Presence = if_else(is.na(SpeciesCounts), 0, 1)) %>%  # presence-absence of species per CowTagID
  select(-SpeciesCounts) %>% 
  left_join(Full_data) %>% 
  select(-spRichness)

# genPA <- taxa %>% 
#   right_join(comp) %>% 
#   drop_na(Genus) %>% 
#   group_by(CowTagID) %>% 
#   count(Genus, name = "presence") %>%
#   pivot_wider(names_from = Genus, values_from = presence) %>%  # extend out to establish NAs
#   pivot_longer(names_to = "Genus", values_to = "presence", cols = 2:32) %>%  #long form to turn NAs into 0's for absence
#  mutate(presence = if_else(is.na(presence), 0, 1)) # presence-absence of species per CowTagID
```


# PCA and Permanova: survey location characteristics

## PCA
```{r}
# extract parameters for the PCA, excluding CT depth
pca_fulldata <- Full_data %>% 
  filter(CowTagID != "VSEEP", CowTagID != "V13") %>% 
  select(Salinity:adj_CT_depth_cm) # avoid rugosity for now

# Run the PCA
pca_full <- prcomp(pca_fulldata, scale. = TRUE, center = TRUE)

# Extract the scores and loadings
PC_scores_full <-as_tibble(pca_full$x[,1:2]) # scores for each sample location
PC_loadings_full<-as_tibble(pca_full$rotation) %>% # loadings for each parameter
  bind_cols(labels = rownames(pca_full$rotation))

# Put it with all the original data
pca_fulldata_all<-Full_data %>% 
  filter(CowTagID != "VSEEP", CowTagID != "V13") %>% 
  bind_cols(PC_scores_full)

```

## scores plot
```{r}
p1_full<-pca_fulldata_all %>%
  ggplot(aes(x = PC1, 
             y = PC2))+
  geom_point(shape = 21,
             color = "white",
             fill = "white",
             size = 3) +
  #coord_cartesian(xlim = c(-4, 7), ylim = c(-6, 4)) +
  #scale_shape_manual(values = c(22,16))+
  scale_colour_hue(l = 45)+ # l: luminance/lightness 0-100
  scale_fill_hue(l = 45)+ 
  #scale_fill_manual(values = mypalette) +
  # ggforce::geom_mark_ellipse(
  #   aes(fill = V_cluster, label = V_cluster), 
  #   alpha = .15, show.legend = FALSE,  label.buffer = unit(1, "mm"))+
  theme_bw()+
  theme(legend.position = "none", panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(title = "Varari Scores Plot") +
  geom_text_repel(aes(label = CowTagID))

p1_full
```

## loadings plot
```{r}
# loadings plot 
p1_full_loading <- PC_loadings_full %>%
  ggplot(aes(x = PC1, y = PC2, label = labels)) + # labels are the parameters
    geom_segment(aes(x = 0,
                     y = 0,
                     xend = PC1*10,
                     yend = PC2*10),
      arrow = arrow(length = unit(0.1,"cm")), 
      color = "grey") +
  annotate("text", 
           x = PC_loadings_full$PC1*10+0.5, 
           y = PC_loadings_full$PC2*10+0.5,
           label = PC_loadings_full$labels,
           size = 3) +
  coord_cartesian(xlim = c(-4, 5), ylim = c(-6, 5)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  labs(title = "Varari Loadings")

p1_full_loading
```

```{r}
### Patch PCA plots
VarariPCA <- p1_full + p1_full_loading + 
  patchwork::plot_annotation("Varari PCA and Loadings", 
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))

ggsave(plot = VarariPCA, filename = here("Output","VarariPCA_meta.png"), width = 14, height = 6)
VarariPCA
```

### species richness ~ PC scores
```{r}
#pca_fulldata_all

anova(lm(data = pca_fulldata_all, spRichness ~ PC1))
anova(lm(data = pca_fulldata_all, spRichness ~ PC2))

pca_fulldata_all %>% 
  groupplot(x = PC1, y = spRichness, fw = NA) +
  scale_color_manual(values = mypalette)

pca_fulldata_all %>% 
  groupplot(x = PC2, y = spRichness, fw = NA) +
  scale_color_manual(values = mypalette)


summary(lm(data = pca_fulldata_all, PC1 ~ dist_to_seep_m)) # p = 0.02
summary(lm(data = pca_fulldata_all, PC2 ~ dist_to_seep_m))

```



# PCA and Permanova: survey location characteristics w/o substrate

## PCA
```{r}
# extract parameters for the PCA, excluding CT depth
pca_fulldata2 <- Full_data %>% 
  filter(CowTagID != "VSEEP", CowTagID != "V13") %>% 
  select(Salinity:N_percent,dist_to_seep_m:adj_CT_depth_cm) # avoid rugosity for now

# Run the PCA
pca_full2 <- prcomp(pca_fulldata2, scale. = TRUE, center = TRUE)

# Extract the scores and loadings
PC_scores_full2 <- as_tibble(pca_full2$x[,1:2]) # scores for each sample location
PC_loadings_full2 <- as_tibble(pca_full2$rotation) %>% # loadings for each parameter
  bind_cols(labels = rownames(pca_full2$rotation))

# Put it with all the original data
pca_fulldata_all2 <- Full_data %>% 
  filter(CowTagID != "VSEEP", CowTagID != "V13") %>% 
  bind_cols(PC_scores_full2)

```

## scores plot
```{r}
p1_full2<-pca_fulldata_all2 %>%
  ggplot(aes(x = PC1, 
             y = PC2))+
  geom_point(shape = 21,
             color = "white",
             fill = "white",
             size = 3) +
  #coord_cartesian(xlim = c(-4, 7), ylim = c(-6, 4)) +
  #scale_shape_manual(values = c(22,16))+
  scale_colour_hue(l = 45)+ # l: luminance/lightness 0-100
  scale_fill_hue(l = 45)+ 
  #scale_fill_manual(values = mypalette) +
  # ggforce::geom_mark_ellipse(
  #   aes(fill = V_cluster, label = V_cluster), 
  #   alpha = .15, show.legend = FALSE,  label.buffer = unit(1, "mm"))+
  theme_bw()+
  theme(legend.position = "none", panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(title = "Varari Scores Plot") +
  geom_text_repel(aes(label = CowTagID))

p1_full2
```

## loadings plot
```{r}
# loadings plot 
p1_full_loading2 <- PC_loadings_full2 %>%
  ggplot(aes(x = PC1, y = PC2, label = labels)) + # labels are the parameters
    geom_segment(aes(x = 0,
                     y = 0,
                     xend = PC1*10,
                     yend = PC2*10),
      arrow = arrow(length = unit(0.1,"cm")), 
      color = "grey") +
  annotate("text", 
           x = PC_loadings_full2$PC1*10+0.5, 
           y = PC_loadings_full2$PC2*10+0.5,
           label = PC_loadings_full2$labels,
           size = 3) +
  coord_cartesian(xlim = c(-4, 5), ylim = c(-6, 5)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  labs(title = "Varari Loadings")

p1_full_loading2
```

```{r}
### Patch PCA plots
VarariPCA2 <- p1_full2 + p1_full_loading2 + 
  patchwork::plot_annotation("Varari PCA and Loadings (w/o substrate)", 
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))

ggsave(plot = VarariPCA2, filename = here("Output","VarariPCA_meta_noSubstrate.png"), width = 14, height = 6)
VarariPCA2
```

### species richness ~ PC scores
```{r}
#pca_fulldata_all2

anova(lm(data = pca_fulldata_all2, spRichness ~ PC1))
anova(lm(data = pca_fulldata_all2, spRichness ~ PC2))

pca_fulldata_all2 %>% 
  groupplot(x = PC1, y = spRichness, fw = NA) +
  scale_color_manual(values = mypalette)

pca_fulldata_all2 %>% 
  groupplot(x = PC2, y = spRichness, fw = NA) +
  scale_color_manual(values = mypalette)


summary(lm(data = pca_fulldata_all2, PC1 ~ dist_to_seep_m)) # p = 0.02
summary(lm(data = pca_fulldata_all2, PC2 ~ dist_to_seep_m))

```




## nMDS Plot: Survey Sites
### Prep data
```{r}
# create ordination output using bray curtis dissimilarity matrix
# remove non-numerical data
# distance = is the type of dissimilarity matrix
# k is number of dimensions (you can try different ones to look at different stress)
CTlevels <- c('V1','V2','V3','V4','V5','V6','V7','V8','V9','V10','V11','V12','V14','V15','V16','V17','V18','V19','V20')

richPerm <- Full_data %>%
  filter(CowTagID != "VSEEP",
         CowTagID != "V13") %>% 
#  select(CowTagID, Salinity:meanRugosity)
 select(CowTagID, Salinity:N_percent, dist_to_seep_m:meanRugosity)
richPerm$CowTagID <- factor(richPerm$CowTagID, levels = CTlevels)
richPerm <- richPerm %>% 
  arrange(CowTagID) %>% # arrange data in order of CowTagID for ordination plot later
  select(-CowTagID)

richOrd <- metaMDS(richPerm, k=2, distance='bray') 

# stress with k=2 dimensions. Is it < 0.3? 
richOrd$stress

# stress plot
# want to minimize scatter
stressplot(richOrd)
```

### Plot nMDS ordinations
```{r}
## ggplot

#summary(richOrd)

# get points for site characteristics
richRow <- rownames(richOrd$species) # get characteristic names

# with substrate
# richMDS1 <- c(richOrd$species[1:23]) # MDS1 for characteristics
# richMDS2 <- c(richOrd$species[24:46]) # MDS2 for characteristics

# without substrate
richMDS1 <- c(richOrd$species[1:19]) # MDS1 for characteristics
richMDS2 <- c(richOrd$species[20:38]) # MDS2 for characteristics

richData <- as_tibble(cbind(richRow, richMDS1, richMDS2)) %>%  # bind all cols into tibble
  mutate(richMDS1 = as.numeric(richMDS1), # as numeric 
         richMDS2 = as.numeric(richMDS2))
# get points for CowTagIDs
richRowb <- as.character(CTlevels) # assign CowTagID names
richMDS1b <- c(richOrd$points[1:19]) # MDS1 for CowTagID
richMDS2b <- c(richOrd$points[20:38]) # MDS2 for CowTagID
richDatab <- as_tibble(cbind(richRowb, richMDS1b, richMDS2b)) %>%  # bind all cols into tibble
  mutate(richMDS1b = as.numeric(richMDS1b), # as numeric 
         richMDS2b = as.numeric(richMDS2b))

# plotting
nMDSplot <- ggplot(data = richData, # sit characteristics
       aes(x = richMDS1,
           y = richMDS2)) +
  geom_point(color = "red", shape = 2) +
  geom_point(data = richDatab, # CowTagIDs
             aes(x = richMDS1b,
                 y = richMDS2b),
             color = "black") +
  geom_text_repel(data = richData, # site characteristics
                  aes(x = richMDS1,
                      y = richMDS2,
                      label = richRow),
                  size = 3) +
  geom_text_repel(data = richDatab, # CowTagIDs
                  aes(x = richMDS1b,
                      y = richMDS2b,
                      label = richRowb),
                  size = 3) +
  #coord_cartesian(xlim = c(-0.23, 0.25), ylim = c(-0.16, 0.09)) +
  theme_bw() +
  theme(panel.grid = element_blank())

nMDSplot
#ggsave(here("Output","nMDS_Varari.png"), nMDSplot, width = 14, height = 9)
```

### PERMANOVA
```{r, echo = F, eval = F}
#We could formally test whether locations are different using a perMANOVA. 
#This requires the adonis command in the vegan package
richPermFull <- cbind(richRowb, richPerm) %>%  # bind cowTagIDs
  rename(CowTagID = richRowb)

permanovamodel<-adonis2(richPermFull[,-c(1)]~CowTagID, richPermFull, permutations = 999, 
                       method="bray") # should change out cowtagid with some grouping name
permanovamodel

#If we are to trust the results of the permanova, then we have to assume that the dispersion among
#data is the same in each group. We can test with assumption with a PermDisp test:
disper<-vegdist(richPermFull[,-c(1)])
betadisper(disper, richPermFull$CowTagID)
#Look at the Average distance to median...these numbers should be reasonably similar
#A rule of thumb is that one number should not be twice as high as any other

pairwise.adonis(richPermFull[-1], richPermFull$CowTagID, perm=999)

#Get coefficients to see which species are most important in explaining site differences:
permanovamodel$coefficients

```

## nMDS Plot: Species
### Prep data
```{r}
# create ordination output using bray curtis dissimilarity matrix
# remove non-numerical data
# distance = is the type of dissimilarity matrix
# k is number of dimensions (you can try different ones to look at different stress)
#CTlevels <- c('V1','V2','V3','V4','V5','V6','V7','V8','V9','V10','V11','V12','V14','V15','V16','V17','V18','V19','V20')


speciesPerm <- comp %>%
  filter(CowTagID != "VSEEP",
         CowTagID != "V13") %>% 
  select(CowTagID, Taxa, sp_percent) %>% 
  pivot_wider(names_from = "Taxa", values_from = "sp_percent") %>% 
  mutate_at(vars('Hard Substrate':'Caulerpa racemosa'), .funs = ~if_else(is.na(.)==TRUE, 0, .)) # put 0 %cover for all NA values

speciesPerm$CowTagID <- factor(speciesPerm$CowTagID, levels = CTlevels)

SiteParam <- comp %>%
  filter(CowTagID != "VSEEP",
         CowTagID != "V13") %>% 
  select(Taxa, sp_percent, Salinity:N_percent, dist_to_seep_m:meanRugosity) %>% 
  #select(Taxa, sp_percent, Salinity:meanRugosity) %>% 
  pivot_wider(names_from = "Taxa", values_from = "sp_percent") %>% 
  mutate_at(vars('Hard Substrate':'Caulerpa racemosa'), .funs = ~if_else(is.na(.)==TRUE, 0, .)) %>%  # put 0 %cover for all NA values
  select(Salinity:meanRugosity)

speciesPerm <- speciesPerm %>% 
  select(-c(CowTagID))

speciesOrd <- metaMDS(speciesPerm, k=2, distance='bray') 

# stress with k=2 dimensions. Is it < 0.3? 
speciesOrd$stress

# stress plot
# want to minimize scatter
stressplot(speciesOrd)
```

### Plot nMDS ordinations
```{r}
## ggplot

#summary(speciesOrd)

# get points for species
speciesRow <- rownames(speciesOrd$species) # get characteristic names
speciesMDS1 <- c(speciesOrd$species[1:60]) # MDS1 for characteristics
speciesMDS2 <- c(speciesOrd$species[61:120]) # MDS2 for characteristics
speciesData <- as_tibble(cbind(speciesRow, speciesMDS1, speciesMDS2)) %>%  # bind all cols into tibble
  mutate(speciesMDS1 = as.numeric(speciesMDS1), # as numeric 
         speciesMDS2 = as.numeric(speciesMDS2)) %>% 
  rename(Taxa = speciesRow) %>% 
  left_join(taxa) %>% 
  mutate(Taxon_Group = if_else(Taxa == "Hard Substrate", "Abiotic", Taxon_Group)) %>% 
  select(Taxa, speciesMDS1, speciesMDS2, Taxon_Group)
# get points for
speciesRowb <- as.character(CTlevels) # assign CowTagID
speciesMDS1b <- c(speciesOrd$points[1:19]) # MDS1 for CowTagID
speciesMDS2b <- c(speciesOrd$points[20:38]) # MDS2 for CowTagID
speciesDatab <- as_tibble(cbind(speciesRowb, speciesMDS1b, speciesMDS2b)) %>%  # bind all cols into tibble
  mutate(speciesMDS1b = as.numeric(speciesMDS1b), # as numeric
         speciesMDS2b = as.numeric(speciesMDS2b))
```

```{r}
# taxonPalette <- tibble('Taxon_Group' = as.character(c("Abiotic", "Sand", "Turf", "Rhodophyta", "")),
#                        'PalColor' = as.character())



# plotting
nMDSplot2 <- ggplot(data = speciesData, # site characteristics
       aes(x = speciesMDS1,
           y = speciesMDS2)) +
  geom_point(aes(color = Taxon_Group),
             size = 3) +
  # geom_point(data = speciesDatab, # CowTagIDs
  #            aes(x = speciesMDS1b,
  #                y = speciesMDS2b), 
  #            shape = 3,
  #            size = 3) +
  geom_text_repel(data = speciesData, # site characteristics
                  aes(x = speciesMDS1,
                      y = speciesMDS2,
                      label = speciesRow),
                  size = 2,
                  max.overlaps = 15) +
  #coord_cartesian(xlim = c(-2, 2), ylim = c(-1.2, 1.2)) +
  theme_bw() +
  theme(panel.grid = element_blank())

nMDSplot2
#ggsave(here("Output","nMDS_Varari.png"), nMDSplot, width = 14, height = 9)
```


```{r}
taxonPalette <- tibble('Taxon_Group' = as.character(c("Abiotic", "Turf", "Macroalgae", "Calcifier", "Sponge", "Corallimorph", "Anemone", "Cyanobacteria")),
                       'PalColor' = as.character(c("black", "#00496F", "#086B8B", "#2E9093", "#EDC132", "#ED950A", "#DD4124", "#b99095")))


#taxonPalette <- pnw_palette(name = "Bay", n = 8)

# broad taxonomic groups
taxonData <- speciesData %>% 
  mutate(Taxon_Group = if_else(Taxon_Group == "Chlorophyta", "Macroalgae", 
                       if_else(Taxon_Group == "Rhodophyta", "Macroalgae",
                       if_else(Taxon_Group == "Phaeophyta", "Macroalgae",
                       if_else(Taxon_Group == "Coral", "Calcifier", 
                       if_else(Taxon_Group == "CCA", "Calcifier",
                       if_else(Taxon_Group == "Sand", "Abiotic", Taxon_Group))))))) %>% 
  left_join(taxonPalette)

Pal <- as.character(taxonData$PalColor)
names(Pal) <- as.character(taxonData$Taxon_Group)

# plotting
nMDSplot2b <- ggplot(data = taxonData, # site characteristics
       aes(x = speciesMDS1,
           y = speciesMDS2)) +
  geom_point(aes(color = Taxon_Group),
             size = 3) +
  # geom_point(data = speciesDatab, # CowTagIDs
  #            aes(x = speciesMDS1b,
  #                y = speciesMDS2b), 
  #            shape = 3,
  #            size = 3) +
  geom_text_repel(data = taxonData, # site characteristics
                  aes(x = speciesMDS1,
                      y = speciesMDS2,
                      label = speciesRow),
                  size = 2,
                  max.overlaps = 15) +
  #coord_cartesian(xlim = c(-2, 2), ylim = c(-1.2, 1.2)) +
  theme_bw() +
  theme(panel.grid = element_blank()) +
  scale_color_manual(values = Pal) +
  labs(x = "MDS1", y = "MDS2", color = "Taxonomic Group")

nMDSplot2b
#ggsave(here("Output","nMDS_Varari.png"), nMDSplot, width = 14, height = 9)
```

### PERMANOVA
```{r, echo = F, eval = F}
#We could formally test whether locations are different using a perMANOVA. 
#This requires the adonis command in the vegan package
speciesPermFull <- cbind(speciesRowb, speciesPerm) %>%  # bind cowTagIDs
  rename(CowTagID = speciesRowb)

permanovamodel2<-adonis2(speciesPermFull[,-c(1:2)]~CowTagID, speciesPermFull, permutations = 999, 
                       method="bray") # should change out cowtagid with some grouping name
permanovamodel2

#If we are to trust the results of the permanova, then we have to assume that the dispersion among
#data is the same in each group. We can test with assumption with a PermDisp test:
disper<-vegdist(speciesPermFull[,-c(1:2)])
betadisper(disper, speciesPermFull$CowTagID)
#Look at the Average distance to median...these numbers should be reasonably similar
#A rule of thumb is that one number should not be twice as high as any other

pairwise.adonis(speciesPermFull[-1], speciesPermFull$Site, perm=999)

#Get coefficients to see which species are most important in explaining site differences:
permanovamodel2$coefficients

```



## Species metrics regrssion against all site characteristics
```{r}
longParam <- Full_data %>% 
  filter(CowTagID != "V13", CowTagID != "VSEEP") %>% 
  select(-c(lat, lon, Location)) %>% 
  pivot_longer(cols = Salinity:meanRugosity, names_to = "Parameter", values_to = "Values") 

groupplot(mydata = longParam, x = spRichness, y = Values, fw = Parameter) +
  scale_color_manual(values = midpalette)


Richness_pval <- tibble(Parameter = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric())
wideParam <- Full_data %>% 
  filter(CowTagID != "V13", CowTagID != "VSEEP") %>% 
  select(-c(lat, lon, Location))

for(i in 3:ncol(wideParam)){
  
  Parameter <- colnames(wideParam)[i] # select dependent parameter
  mod <- lm(paste(Parameter, "~", "spRichness"), data = wideParam)
  pvalue <- summary(mod)[4]$coefficients[8]
  adj_r_squared <- summary(mod)[9]$adj.r.squared
  
  temp <- as_tibble(cbind(Parameter, pvalue, adj_r_squared)) %>% 
    mutate(pvalue = as.numeric(pvalue),
           adj_r_squared = as.numeric(adj_r_squared))
  
  Richness_pval <- Richness_pval %>% 
    rbind(temp)
}

# view table of pvalues
Richness_pval

# view bar graph of pvalues with 0.05 cutoff
Richness_pval %>% 
  ggplot(aes(x = Parameter, y = pvalue)) +
  geom_col() +
  geom_hline(yintercept = 0.05) +
  theme_bw() +
  labs(y = "p-value: ~ Species Richness") +
  theme(axis.text.x = element_text(angle = 90))
  
```




# Normalize to substrate and rugosity

## Richness ~ Rugosity
```{r}
## plot
groupplot(mydata = Full_data, x = meanRugosity, y = spRichness, fw = NA) +
  geom_text_repel(aes(label = CowTagID)) +
  scale_color_manual(values = mypalette)

# A residual is the difference between an observed value and a predicted value in a regression model. Residual = Observed value – Predicted value
# An observation has a positive residual if its value is greater than the predicted value made by the regression line and a negative residual if its value is less than the predicted value made by the regression line.

#fit model
resMod <- lm(spRichness ~ meanRugosity, data=Full_data %>% filter(CowTagID != "V13", CowTagID != "VSEEP"))

#view model summary
summary(resMod) 

#calculate the standardized residuals
res <- residuals(resMod)

#view the standardized residuals
res

#column bind standardized residuals back to original data frame
res_data <- Full_data %>% 
  filter(CowTagID != "V13", CowTagID != "VSEEP") %>% 
  cbind(res) %>% 
  relocate(res, .after = CowTagID)

#plot predictor variable vs. standardized residuals
res_data %>% 
  ggplot(aes(x = meanRugosity,
             y = res)) +
  geom_point(color = if_else(res > 0, "black", "red")) +
  geom_text_repel(aes(label = CowTagID)) +
  theme_bw()


# plot residuals against distance parameter
respval <- anova(lm(data = res_data, res ~ dist_to_seep_m))[5]$'Pr(>F)'[1]

res_data %>% 
  ggplot(aes(x = dist_to_seep_m,
             y = res)) +
  geom_point() +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() + theme(panel.grid = element_blank()) +
  labs(y = "Residuals (Species Richness ~ Mean Rugosity)",
       x = "Distance to seepage point (m)",
       caption = paste("p-value:",round(respval,2)))

```



## Residuals regressions
```{r}
anova(lm(data = res_data, spRichness ~ res))


res_pval <- tibble(Parameter = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric())


for(i in 4:ncol(res_data %>% select(-c(lat,lon)))){
  
  Parameter <- colnames(res_data %>% select(-c(lat,lon)))[i] # select dependent parameter
  mod <- lm(paste(Parameter, "~", "res"), data = res_data)
  pvalue <- summary(mod)[4]$coefficients[8]
  adj_r_squared <- summary(mod)[9]$adj.r.squared
  
  temp <- as_tibble(cbind(Parameter, pvalue, adj_r_squared)) %>% 
    mutate(pvalue = as.numeric(pvalue),
           adj_r_squared = as.numeric(adj_r_squared))
  
  res_pval <- res_pval %>% 
    rbind(temp)
}

# view table of pvalues
res_pval

# view bar graph of pvalues with 0.05 cutoff
res_pval %>% 
  ggplot(aes(x = Parameter, y = pvalue)) +
  geom_col() +
  geom_hline(yintercept = 0.05) +
  theme_bw() +
  labs(y = "p-value: ~ Residuals") +
  theme(axis.text.x = element_text(angle = 90))
  
```


# PCA with residuals


# PCA and Permanova: survey location characteristics w/o substrate

## PCA
```{r}
# extract parameters for the PCA, excluding CT depth
pca_fulldata3 <- res_data %>% 
  relocate(res, .after=lon) %>% 
  select(res:N_percent,dist_to_seep_m:adj_CT_depth_cm) # avoid rugosity because rugosity residuals

# Run the PCA
pca_full3 <- prcomp(pca_fulldata3, scale. = TRUE, center = TRUE)

# Extract the scores and loadings
PC_scores_full3 <- as_tibble(pca_full3$x[,1:2]) # scores for each sample location
PC_loadings_full3 <- as_tibble(pca_full3$rotation) %>% # loadings for each parameter
  bind_cols(labels = rownames(pca_full3$rotation))

# Put it with all the original data
pca_fulldata_all3 <- res_data %>% 
  relocate(res, .after=lon) %>% 
  bind_cols(PC_scores_full3) %>% 
  select(-meanRugosity)

```

## scores plot
```{r}
p1_full3<-pca_fulldata_all3 %>%
  ggplot(aes(x = PC1, 
             y = PC2))+
  geom_point(shape = 21,
             color = "white",
             fill = "white",
             size = 3) +
  #coord_cartesian(xlim = c(-4, 7), ylim = c(-6, 4)) +
  #scale_shape_manual(values = c(22,16))+
  scale_colour_hue(l = 45)+ # l: luminance/lightness 0-100
  scale_fill_hue(l = 45)+ 
  #scale_fill_manual(values = mypalette) +
  # ggforce::geom_mark_ellipse(
  #   aes(fill = V_cluster, label = V_cluster), 
  #   alpha = .15, show.legend = FALSE,  label.buffer = unit(1, "mm"))+
  theme_bw()+
  theme(legend.position = "none", panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(title = "Varari Scores Plot") +
  geom_text_repel(aes(label = CowTagID))

p1_full3
```

## loadings plot
```{r}
# loadings plot 
p1_full_loading3 <- PC_loadings_full3 %>%
  ggplot(aes(x = PC1, y = PC2, label = labels)) + # labels are the parameters
    geom_segment(aes(x = 0,
                     y = 0,
                     xend = PC1*10,
                     yend = PC2*10),
      arrow = arrow(length = unit(0.1,"cm")), 
      color = "grey") +
  annotate("text", 
           x = PC_loadings_full3$PC1*10+0.5, 
           y = PC_loadings_full3$PC2*10+0.5,
           label = PC_loadings_full3$labels,
           size = 3) +
  coord_cartesian(xlim = c(-4, 5), ylim = c(-6, 5)) +
  theme_bw() +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  labs(title = "Varari Loadings")

p1_full_loading3
```

```{r}
### Patch PCA plots
VarariPCA3 <- p1_full3 + p1_full_loading3 + 
  patchwork::plot_annotation("Varari PCA and Loadings (w/ Residuals)", 
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))

ggsave(plot = VarariPCA3, filename = here("Output","VarariPCA_meta_residuals.png"), width = 14, height = 6)
VarariPCA3
```




# Plotting full biogeochemical regressions
## For loop create plots of all parameters against each other
### With seep
```{r, message = F, warning = F, eval = F}
red_Full <- Full_data %>% 
  select(-c(Location, lat, lon))

p <- list()


for(i in 2:ncol(red_Full)) {
  
  x.col <- colnames(red_Full[,i]) # select ith parameter as x axis variable
  
  q <- list()
  
  for(j in 3:ncol(red_Full)) {
    
    y.col <- colnames(red_Full[,j]) # select jth parameter as y axis variable
    
    temp <- red_Full %>% 
      rename('x' = x.col,
             'y' = y.col)
    
    q[[j-2]] <- ggplot(data = temp, aes(x = x, y = y)) +
      geom_point() +
      geom_smooth(color = "black", method = "lm") + 
      theme_bw() + 
      theme(axis.title.x = element_blank(),
            axis.title = element_text(size = 8)) +
      labs(y = y.col)
      
  }
  
  p[[i-1]] <- (q[[1]]+q[[2]]+q[[3]]+q[[4]]+q[[5]]+q[[6]])/
  (q[[7]]+q[[8]]+q[[9]]+q[[10]]+q[[11]]+q[[12]])/
  (q[[13]]+q[[14]]+q[[15]]+q[[16]]+q[[17]]+q[[18]])/
  (q[[19]]+q[[20]]+q[[21]]+q[[22]]+q[[23]]) + 
    plot_annotation(title = paste("~", x.col))
  
  
}

# Save all plots in a single pdf
pdf(here("Output","Full_biogeochem_regression_withSeep.pdf"), onefile = TRUE)
for (i in 1:length(p)) {
  tplot <- p[[i]]
  print(tplot)
}
dev.off()
```

### Parameter regression pvalues with seep
```{r}
red_Full <- Full_data %>% 
  select(-c(Location, lat, lon))

seepParam_pval <- tibble(Parameter_Ind = as.character(),
                         Parameter_Dep = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric())


for(i in 2:ncol(red_Full)) {
  
  Parameter_Ind <- colnames(red_Full[,i]) # select ith parameter as x axis variable 
  
  temp1 <- tibble(Parameter_Ind = as.character(),
                         Parameter_Dep = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric()) 
  
  for(j in 3:ncol(red_Full)) {
  
  if(i != j){
    Parameter_Dep <- colnames(red_Full[,j]) # select ith parameter as x axis variable
  } else if(j < 25) {
    Parameter_Dep <- colnames(red_Full[,(j+1)]) # select ith parameter as x axis variable
  } else if(j == 25) {
    Parameter_Dep <- colnames(red_Full[,2]) # select ith parameter as x axis variable
  }
    
  mod <- lm(paste(Parameter_Ind, "~", Parameter_Dep), data = red_Full)
  pvalue <- summary(mod)[4]$coefficients[8]
  adj_r_squared <- summary(mod)[9]$adj.r.squared
  
  temp <- as_tibble(cbind(Parameter_Ind, Parameter_Dep, pvalue, adj_r_squared)) %>% 
    mutate(pvalue = as.numeric(pvalue),
           adj_r_squared = as.numeric(adj_r_squared))
  
  temp1 <- temp1 %>% 
    rbind(temp)
  
  }
  
    seepParam_pval <- seepParam_pval %>% 
    rbind(temp1) %>% 
      distinct()
}

# view table of pvalues
seepParam_pval
write_csv(seepParam_pval, here("Data", "biogeochem_pvalues.csv"))

```


### No seep
```{r, message = F, warning = F, eval = F}
red_Full <- Full_data %>%
  select(-c(Location, lat, lon)) %>% 
  filter(CowTagID != "VSEEP")

p <- list()


for(i in 2:ncol(red_Full)) {
  
  x.col <- colnames(red_Full[,i]) # select ith parameter as x axis variable
  
  q <- list()
  
  for(j in 3:ncol(red_Full)) {
    
    y.col <- colnames(red_Full[,j]) # select jth parameter as y axis variable
    
    temp <- red_Full %>% 
      rename('x' = x.col,
             'y' = y.col)
    
    q[[j-2]] <- ggplot(data = temp, aes(x = x, y = y)) +
      geom_point() +
      geom_smooth(color = "black", method = "lm") + 
      theme_bw() + 
      theme(axis.title.x = element_blank(),
            axis.title = element_text(size = 8)) +
      labs(y = y.col)
      
  }
  
  p[[i-1]] <- (q[[1]]+q[[2]]+q[[3]]+q[[4]]+q[[5]]+q[[6]])/
  (q[[7]]+q[[8]]+q[[9]]+q[[10]]+q[[11]]+q[[12]])/
  (q[[13]]+q[[14]]+q[[15]]+q[[16]]+q[[17]]+q[[18]])/
  (q[[19]]+q[[20]]+q[[21]]+q[[22]]+q[[23]]) + 
    plot_annotation(title = paste("~", x.col))
  
  
}

# Save all plots in a single pdf
pdf(here("Output","Full_biogeochem_regression_noSeep.pdf"), onefile = TRUE)
for (i in 1:length(p)) {
  tplot <- p[[i]]
  print(tplot)
}
dev.off()
```


### Parameter regression pvalues without seep
```{r}
red_Full_noseep <- Full_data %>%
  select(-c(Location, lat, lon)) %>% 
  filter(CowTagID != "VSEEP")

seepParam_pval_noSeep <- tibble(Parameter_Ind = as.character(),
                         Parameter_Dep = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric())


for(i in 2:ncol(red_Full_noseep)) {
  
  Parameter_Ind <- colnames(red_Full_noseep[,i]) # select ith parameter as x axis variable 
  
  temp1 <- tibble(Parameter_Ind = as.character(),
                         Parameter_Dep = as.character(),
                        pvalue = as.numeric(),
                        adj_r_squared = as.numeric()) 
  
  for(j in 3:ncol(red_Full_noseep)) {
  
  if(i != j){
    Parameter_Dep <- colnames(red_Full_noseep[,j]) # select ith parameter as x axis variable
  } else if(j < 25) {
    Parameter_Dep <- colnames(red_Full_noseep[,(j+1)]) # select ith parameter as x axis variable
  } else if(j == 25) {
    Parameter_Dep <- colnames(red_Full_noseep[,2]) # select ith parameter as x axis variable
  }
    
  mod <- lm(paste(Parameter_Ind, "~", Parameter_Dep), data = red_Full_noseep)
  pvalue <- summary(mod)[4]$coefficients[8]
  adj_r_squared <- summary(mod)[9]$adj.r.squared
  
  temp <- as_tibble(cbind(Parameter_Ind, Parameter_Dep, pvalue, adj_r_squared)) %>% 
    mutate(pvalue = as.numeric(pvalue),
           adj_r_squared = as.numeric(adj_r_squared))
  
  temp1 <- temp1 %>% 
    rbind(temp)
  
  }
  
    seepParam_pval_noSeep <- seepParam_pval_noSeep %>% 
    rbind(temp1) %>% 
      distinct()
}

# view table of pvalues
seepParam_pval_noSeep
write_csv(seepParam_pval_noSeep, here("Data", "biogeochem_pvalues_noSeep.csv"))
```


## Plotting richness along parameters

### with seep
```{r}
red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = Phosphate_umolL, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Phosphate (umol L-1)")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = pH, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ pH")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = TA, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ TA")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = DeadCoral, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Dead Coral % cover")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = dist_to_seep_m, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Distance to seep (m)")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = TA, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ TA")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = TSalinity, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Salinity")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = Sand, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Sand")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = meanRugosity, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Mean Rugosity")
```

### no seep
```{r}
red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = Ammonia_umolL, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Ammonia (umol L-1)")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = DeadCoral, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Dead Coral % cover")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = dist_to_seep_m, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Distance to seep (m)")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = VisibleHumidic_Like, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ VisibleHumidic_Like")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = Sand, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Sand")

red_Full_noseep$CowTagID <- order(data = red_Full_noseep, param = meanRugosity, by = CowTagID)$CowTagID
colplot(mydata = red_Full_noseep, y = spRichness) +labs(title = " ~ Mean Rugosity")
```



## richness across macroalgal taxa
```{r, eval = F}

abun <- comp %>% 
  group_by(CowTagID) %>% 
  mutate(total = sum(SpeciesCounts),
         cover = SpeciesCounts / total * 100) %>%
  select(Location, CowTagID, Taxa, SpeciesCounts, cover) %>% 
  left_join(water) %>% 
  left_join(taxa) %>% 
  drop_na(Season) %>% 
  filter(Season == "Dry") %>% 
  filter(Location == "Varari")

abun$CowTagID <- order(data = abun, param = Ammonia_umolL, by = CowTagID)$CowTagID
  
a <- abun %>% 
  filter(Taxon_Group %in% c("Turf", "Rhodophyta", "Phaeophyta", "Chlorophyta")) %>% 
  ggplot(aes(x = CowTagID,
             y = cover,
             fill = Taxon_Group)) +
  geom_col(position = "stack") +
  facet_wrap(~Taxon_Group, scales = "free_y") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.key.size = unit(1, "line"),
        legend.text = element_text(size = 5)) +
  labs(fill = "Taxa")

b <- abun %>% 
  filter(Season == "Dry") %>% 
  ggplot(aes(x = CowTagID,
             y = Ammonia_umolL)) +
  geom_point() +
  theme_bw()

c <- abun %>% 
  filter(Taxon_Group %in% c("Turf", "Rhodophyta", "Phaeophyta", "Chlorophyta")) %>% 
  ggplot(aes(x = CowTagID,
             y = cover),
         fill = "red") +
  geom_col(position = "stack") +
  theme_bw() +
  theme(panel.grid = element_blank())

a + (c / b)

```


## Algae % cover ~ N_percent
```{r, eval = F}
abun$CowTagID <- order(data = abun, param = N_percent, by = CowTagID)$CowTagID
  
a <- abun %>% 
  filter(Taxon_Group %in% c("Turf", "Rhodophyta", "Phaeophyta", "Chlorophyta")) %>% 
  ggplot(aes(x = CowTagID,
             y = cover,
             fill = Taxon_Group)) +
  geom_col(position = "stack") +
  facet_wrap(~Taxon_Group, scales = "free_y") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.key.size = unit(1, "line"),
        legend.text = element_text(size = 5)) +
  labs(fill = "Taxa")

b <- abun %>% 
  filter(Season == "Dry") %>% 
  ggplot(aes(x = CowTagID,
             y = N_percent)) +
  geom_point() +
  theme_bw()

c <- abun %>% 
  filter(Taxon_Group %in% c("Turf", "Rhodophyta", "Phaeophyta", "Chlorophyta")) %>% 
  ggplot(aes(x = CowTagID,
             y = cover),
         fill = "red") +
  geom_col(position = "stack") +
  theme_bw() +
  theme(panel.grid = element_blank())
a + (b / c)

```

## Coral % cover ~ Silicate
```{r, eval = F}
abun$CowTagID <- order(data = abun, param = Silicate_umolL, by = CowTagID)$CowTagID
  
a <- abun %>% 
  filter(Taxon_Group %in% c("Coral", "Corallimorph")) %>% 
  ggplot(aes(x = CowTagID,
             y = cover,
             fill = Taxon_Group)) +
  geom_col(position = "stack") +
  facet_wrap(~Taxon_Group, scales = "free_y") +
  theme_bw() +
  theme(panel.grid = element_blank(),
        legend.position = "top",
        legend.direction = "horizontal",
        legend.key.size = unit(1, "line"),
        legend.text = element_text(size = 5)) +
  labs(fill = "Taxa")

b <- abun %>% 
  filter(Season == "Dry") %>% 
  ggplot(aes(x = CowTagID,
             y = Silicate_umolL)) +
  geom_point() +
  theme_bw()

c <- abun %>% 
  filter(Taxon_Group %in% c("Coral", "Corallimorph")) %>% 
  ggplot(aes(x = CowTagID,
             y = cover),
         fill = "red") +
  geom_col(position = "stack") +
  theme_bw() +
  theme(panel.grid = element_blank())
a + (b / c)

```






# Mapping Survey Locations

```{r}

# mean lat and long for the maps
LocationGPS <- Full_data %>%
  filter(CowTagID != "V13") %>% 
  group_by(Location) %>% # varari vs cabral
  summarise(lon = median(lon, na.rm = TRUE),
            lat = median(lat, na.rm = TRUE))


# Varari
VarariBaseMap<-get_map(LocationGPS %>% filter(Location == "Varari") %>% select(lon,lat), maptype = 'satellite', zoom = 19)

# base map
# Varari
VmapSites <- ggmap(VarariBaseMap) +
  geom_point(data = Full_data %>% filter(CowTagID != "V13"),
             aes(x = lon, y = lat),
             color = "white",
             size = 2) + 
  labs(x = "Longitude", y = "Latitude",  #label x and y axes
        title = "Varari Sample Locations") +
  geom_label(data = Full_data %>% filter(CowTagID != "V13"),
             aes(x = lon, y = lat,
                 label = CowTagID),
             size = 2, alpha = 0.8)

VmapSites
```

```{r}
### Map Varari clusters

# isolate Varari seep
VSeepPt <- Full_data %>% filter(CowTagID == "VSEEP") 
  

reg_varari_map <- ggmap(VarariBaseMap) +
  geom_point(data = Full_data %>% filter(CowTagID != "VSEEP", CowTagID != "V13"),
             aes(x = lon, y = lat, fill = N_percent),
             shape = 21,
             color = "black",
             fill = "white",
             size = 3) + # set color aesthetics
  #scale_fill_gradient(low = "yellow", high = "red") +
  geom_point(data = VSeepPt, # star the seepage point
             aes(x = lon, y = lat),
             shape = 18, # selects the palette color corresponding to the associated cluster number
             color = "white",
             size = 4) +
  labs(x = "Longitude", y = "Latitude",  #label x and y axes
        title = "Varari Survey Locations",
       fill = "Relative SGD Influence")

reg_varari_map

```

