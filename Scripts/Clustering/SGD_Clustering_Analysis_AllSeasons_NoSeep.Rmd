---
title: "SGD Clustering - Excluding Seep"
author: "Danielle Barnas"
date: "8/18/2022"
output:
  html_document:
    toc: true
    toc_float: true
---

# Clustering Analysis

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```


## Load Libraries
```{r, results='hide', message=FALSE}

#options('repos' = c(options('repos')$repos, RSPM = "https://my-repo.com/all/latest"))

library(tidyverse)
library(curl) # pull data from url
library(here)
library(lubridate)
library(VarSelLCM) # LCM - cluster modeling
library(ggmap)
library(PNWColors)
library(tidytext) # arrange data in a facet_wrap
library(kableExtra) # create neat tables
library(ggrepel) # labeling
library(ggpmisc) # add R2 to figures
library(patchwork)
 
# API<-names(read_table(here("Data","API.txt")))
# register_google(key = API) ### uses my API in separate txt file

set.seed(7) # set the seed to get the same one every time
```

## Read in Data
```{r}
## Read in data - biogeochem data processed in Nutrient_Processing script
Full_data_season_csv<-read_csv(here("Data","Biogeochem","Nutrient_Processed_CV_seasons.csv"))
Full_data_csv<-read_csv(here("Data","Biogeochem","Nutrient_Processed_CV.csv"))

```



## Check relationships to silicate
### across seasons
```{r}
Full_data <- Full_data_csv
Full_data_season <- Full_data_season_csv

## first check linear relationships with silicate
Full_data %>% 
  select(Location, CowTagID, Silicate_umolL, del15N, C_N, N_percent) %>% 
  pivot_longer(cols = c(del15N:N_percent), names_to = "Parameters", values_to = "Values") %>% 
  filter(CowTagID != "VSEEP" & CowTagID != "CSEEP") %>% 
  #filter(Silicate_umolL < 15) %>% # for now remove C2 and seep silicate data
  ggplot(aes(x = Silicate_umolL, 
             y = Values,
             color = Location
             )) +
  geom_point() +
  geom_smooth(method = "lm") +
  labs(x = "Range Silicate (umolL)") +
  facet_wrap(~Parameters, scales = "free") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"))
```

### %N ~ Silicate
### by season
```{r}
## N_percent ~ Silicate
# linear model of %N with respect to silicate
Vdata <- Full_data_season %>% 
  filter(Location == "Varari") %>% 
  filter(CowTagID != "VSEEP")
Vmodel <- lm(data = Vdata, N_percent ~ Silicate_umolL)
Cdata <- Full_data_season %>%
  filter(Location == "Cabral") %>% 
  filter(CowTagID != "CSEEP")
Cmodel <- lm(data = Cdata, N_percent ~ Silicate_umolL)

# display r squared values for lm
Vsum <- summary(Vmodel)$r.squared
Csum <- summary(Cmodel)$r.squared

# graph relationsip
Full_data_season %>% 
  filter(CowTagID != "VSEEP" & CowTagID != "CSEEP") %>% 
  ggplot(aes(x=Silicate_umolL,
             y = N_percent,
             group = Location)) +
  geom_point(aes(color = Season)) +
  geom_smooth(method = "lm", aes(color = Season, group = Season)) +
  labs(caption = paste("Varari R-squared:",round(Vsum, 2), "\n",
                       "Cabral R-squared:", round(Csum, 2)),
       x = "CV of Silicate (umolL)",
       y = "% Nitrogen") +
  facet_wrap(~Location, scales = "free") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"))
```

### del15N ~ Silicate
### by season
```{r}
## del15N ~ Silicate
# linear model of del15N with respect to silicate
Vdata <- Full_data_season %>% 
  filter(Location == "Varari") %>% 
  filter(CowTagID != "VSEEP")
Vmodel <- lm(data = Vdata, del15N ~ Silicate_umolL)
Cdata <- Full_data_season %>%
  filter(Location == "Cabral") %>% 
  filter(CowTagID != "CSEEP")
Cmodel <- lm(data = Cdata, del15N ~ Silicate_umolL)

# display r squared values for lm
Vsum <- summary(Vmodel)$r.squared
Csum <- summary(Cmodel)$r.squared

# graph relationship
Full_data_season %>% 
  filter(CowTagID != "VSEEP" & CowTagID != "CSEEP") %>% 
  ggplot(aes(x=Silicate_umolL,
             y = del15N,
             group = Location)) +
  geom_point(aes(color = Season)) +
  geom_smooth(method = "lm", aes(color = Season, group = Season)) +
  labs(caption = paste("Varari R-squared:",round(Vsum, 2), "\n",
                       "Cabral R-squared:", round(Csum, 2)),
       x = "CV of Silicate (umolL)",
       y = "delta N15") +
  facet_wrap(~Location, scales = "free") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"))
```

## Remove Seepage points from Full_data
```{r}
Full_data <- Full_data %>% 
  filter(CowTagID != "VSEEP", CowTagID != "CSEEP")
Full_data_season <- Full_data_season %>% 
  filter(CowTagID != "VSEEP", CowTagID != "CSEEP")
```


## Test for normality
### across seasons
```{r, message = F}

# get column names and total # cols
numbData <- Full_data %>% 
  select_at(vars(Salinity:N_percent))
numbNames <- colnames(numbData)

# create list to put plots into
q <- list()

# save hist for each variable
for(i in 1:ncol(numbData)){
  
# test for normality
norm <- shapiro.test(Full_data[[numbNames[i]]])
# norm[[2]] shows p-value
signif <- ifelse(norm[[2]] >= 0.05, "Normal", "Not Normal")

# plot histogram  
 p <- Full_data %>%
   ggplot(aes(x = Full_data[[numbNames[i]]])) + 
   geom_histogram() +
   labs(x = numbNames[i],
        title = paste0(numbNames[i],": ",signif),
        subtitle = paste("p =",norm[[2]], "(Shapiro Wilk Test)")) +
   theme_bw()
 #ggsave(here("Output","SGDZones","histograms","meanValues",paste0("mean_",numbNames[i],"_hist.png")),p) # save in hist folder
 
 # to save as single pdf:
 # Create Plot and save to list p
  q[[i]] <- p
}

# Save all plots in a single dated pdf
#pdf(here("Output","SGDZones","histograms",paste0("March_hist.pdf")), onefile = TRUE)
# for (i in seq(length(q))) {
#   tplot <- q[[i]]
#   print(tplot)
# }
#dev.off()

```


## Transform and scale data

- ln transform left-skewed data
- square root transform right-skewed data
```{r, message= F}
Trans_data <- Full_data %>%
  mutate_at(.vars = c('Salinity', 'TA', 'pH', 'Phosphate_umolL'
                      # 'del15N',
                       #'Silicate_umolL',
                       #'NN_umolL'
                    #   'Tryptophan_Like',
                    #   'Ammonia_umolL',
                    #   'N_percent',
                    #   'HIX',
                    # #  'Lignin_Like',
                    #   'M_C',
                    # #  'MarineHumic_Like',
                    #   'Tyrosine_Like',
                    #   'VisibleHumidic_Like'
                    ),
            .funs = ~log(.x + 0.001), na.rm = T) #%>%  # ln transform for left-skewed
  # mutate_at(.vars = c('Salinity',
  #                     'pH'),
  #           .funs = ~sqrt(.x + 0.01)) # square root transform for right-skewed
```


Test for normality
```{r, message = F, eval = F, echo = F}
# # get column names and total # cols
# numbData <- Trans_data %>% 
#   select_at(vars(Salinity:N_percent))
# numbNames <- colnames(numbData)
# 
# # create list to put plots into
# q <- list()
# 
# # save hist for each variable
# for(i in 1:ncol(numbData)){
#   
# # test for normality
# norm <- shapiro.test(Trans_data[[numbNames[i]]])
# # norm[[2]] shows p-value
# signif <- ifelse(norm[[2]] >= 0.05, "Normal", "Not Normal")
# 
# # plot histogram  
#  p <- Trans_data %>%
#    ggplot(aes(x = Trans_data[[numbNames[i]]])) + 
#    geom_histogram() +
#    labs(x = numbNames[i],
#         title = paste0("Transformed ",sumParam," ",numbNames[i],": ",signif),
#         subtitle = paste("p =",norm[[2]], "(Shapiro Wilk Test)")) +
#    theme_bw()
#  #ggsave(here("Output","SGDZones","histograms","meanValues",paste0("transformed_mean_",numbNames[i],"_hist.png")),p) # save in hist folder
#  
#  # to save as single pdf:
#  # Create Plot and save to list p
#   q[[i]] <- p
# }
# 
# # Save all plots in a single dated pdf
# pdf(here("Output","SGDZones","histograms",paste0("Transformed_",sumParam,"_Histograms.pdf")), onefile = TRUE)
# for (i in seq(length(q))) {
#   tplot <- q[[i]]
#   print(tplot)
# }
# dev.off()
  
```


Scale the data (and maybe center it?)
```{r}
## scale data
# Scale_data <- Trans_data %>% 
Scale_data <- Trans_data %>% 
  mutate_at(vars(Salinity:N_percent),
            .funs = ~scale(.x, center=T, scale=T), na.rm = T)


```



## Prepare for Clustering

Taking from the VarSelLCM.R script

Separate data for Varari and Cabral locations
```{r}
V_data <-Scale_data %>% filter(Location == "Varari")
C_data <-Scale_data %>% filter(Location == "Cabral")

## Force type data.frame
class(V_data) = "data.frame" 
class(C_data) = "data.frame"

```



Indicate the number of cores you want to use for parallelization
```{r}
nb.CPU <- 4 # cores on my computer dedicated to the process (want to use ~ half)
```


## Clustering
This section performs a clustering analysis of the *biogeochemistry and* **Turbinaria ornata** *nutrient* data set. 

*Warning the univariate margin distribution are defined by class of the features: numeric columns imply Gaussian distributions, integer columns imply Poisson distribution while factor (or ordered) columns imply multinomial distribution*
```{r}
# Data loading:
# x contains the observed variables
# z the known status (i.e. 1: Plate and 2: Seep)
# ztrue_V <- V_data[,'N_percent'] # compare clustering with N_percent in turb
# ztrue_C <- C_data[,'N_percent']

x_V <- V_data[,6:ncol(V_data)] # all biogeochemical and turb nutrient data
x_C <- C_data[,6:ncol(V_data)]

x_V <- x_V %>% 
  mutate_all(.funs = as.numeric)
  
x_C <- x_C %>% 
  mutate_all(.funs = as.numeric)

```


Clustering is performed with or without variable selection. 
Model selection is done with BIC because the number of observations is large (compared to the number of features).

```{r, comment=""}
# Cluster analysis without variable selection
res_without_V <- VarSelCluster(x_V, # matrix/data frame (only the numerical data for now) 
                             gvals = 1:ncol(x_V), # defines number of components (clusters) to consider
                             vbleSelec = FALSE, # indicates if a variable selection is done
                             crit.varsel = "BIC") # defines the info criterion used for model selection
res_without_C <- VarSelCluster(x_C, 
                             gvals = 1:ncol(x_C), 
                             vbleSelec = FALSE, 
                             crit.varsel = "BIC")


# Cluster analysis with variable selection (with parallelization)
res_with_V <- VarSelCluster(x_V, 
                          gvals = 1:ncol(x_V), 
                          vbleSelec = TRUE, # indicates if a variable selection is done 
                          crit.varsel = "BIC")
res_with_C <- VarSelCluster(x_C, 
                          gvals = 1:ncol(x_C), 
                          vbleSelec = TRUE,
                          crit.varsel = "BIC")

```

Comparison of the BIC for both models: variable selection permits to improve the BIC
```{r, comment=""}
## Varari
BIC(res_without_V)
BIC(res_with_V) 

if(abs(BIC(res_without_V)) < abs(BIC(res_with_V))){ # choose lowest BIC
  res_V <- res_without_V} else {
  res_V <- res_with_V
  }

## Cabral
BIC(res_without_C)
BIC(res_with_C) 

if(abs(BIC(res_without_C)) < abs(BIC(res_with_C))){ # choose lowest BIC
  res_C <- res_without_C} else {
  res_C <- res_with_C
  }
```


Evaluation of the partition accuracy: Adjusted Rand Index (ARI) is computed between the true partition (ztrue) and its estimators.
The expectation of ARI is zero if the two partitions are independent. 
The ARI is equal to one if the partitions are equals.
Variable selection permits to improve the ARI.
Note that ARI cannot be used for model selection in clustering, because there is no true partition.

Partition near 0 indicates that the clusters are very related to the factor we related the matrix to.
Can compare other factors in the future (ie. bacteria communities or coral counts, etc.)
```{r, comment="", eval = F, echo = F}
## Varari
ARI(ztrue_V, fitted(res_V))
## Cabral
ARI(ztrue_C, fitted(res_C))

```

To obtained the partition and the probabilities of classification
```{r, comment=""}
# Estimated partition - pulls out cluster enumerations in order of parameters
V_cluster<-fitted(res_V)
C_cluster<-fitted(res_C)

# Estimated probabilities of classification
#head(fitted(res_V, type="probability"))
#head(fitted(res_C, type="probability"))
```

```{r, comment="", echo=F, eval=F}
## To get a summary of the selected model.

# Summary of the best model
#summary(V_cluster)
#summary(C_cluster)

#summary(res_V) 
#summary(res_C) 
```


## Discriminative Power Barplots

Distribution of the most discriminative variable per clusters
```{r, comment=""}
# Barplots

Vdes<-plot(x = res_V, y = 1:ncol(x_V))
Cdes<-plot(x = res_C, y = 1:ncol(x_C))

ggsave(here("Output","SGDZones","Varari",paste0("DiscPower_allnoseep_Varari.png")),Vdes, height = 10, width = 10)
ggsave(here("Output","SGDZones","Cabral",paste0("DiscPower_allnoseep_Cabral.png")),Cdes, height = 10, width = 10)

```

## Empirical vs Theoretical distributions (quick check for good fit)

Example empirical and theoretical distributions of the most discriminative variable (to check that the distribution is well-fitted)
```{r, comment=""}
# Empirical and theoretical distributions (to check that the distribution is well-fitted)

plot(res_V, y="N_percent", type="cdf")
plot(res_C, y="Silicate_umolL", type="cdf")

```

Distribution of a categorical variable per clusters
(when we have categorical)
```{r, comment="", eval = F, echo = F}
# Summary of categorical variable
# plot(res_with, y="Shore_Habitat")
```

To have details about the selected model
```{r, comment="", eval = F, echo = F}
# More detailed output
print(res_V)
print(res_C)
```

To print the parameters
```{r, comment="", eval = F, echo = F}
# Print model parameter
# coef(res_C)
# coef(res_V)
```


```{r, comment="", eval=F, echo=F}
## Probabilities of classification for new observations 
#(I don't know what this is)

# Probabilities of classification for new observations 
# predict(res_with, newdata = x[1:3,])
```



## Graph

Add site locations to cluster value df
```{r}
# make cluster vector dataframe type to join to full_data
V_cluster<-as.data.frame(V_cluster)
C_cluster<-as.data.frame(C_cluster)

# join cluster ID's to full_data
V_Cluster_data<-V_data %>% 
  cbind(V_cluster) %>% 
  mutate(V_cluster = as.factor(V_cluster))
C_Cluster_data<-C_data %>% 
  cbind(C_cluster) %>% 
  mutate(C_cluster = as.factor(C_cluster))

V_meta <- V_Cluster_data %>% rename(cluster = V_cluster) %>% mutate_at(vars(Salinity:N_percent),.funs = as.numeric) %>% 
  mutate(cluster = if_else(cluster == 3, "Low", if_else(cluster == 2, "Mid", "High")))
C_meta <- C_Cluster_data %>% rename(cluster = C_cluster) %>% mutate_at(vars(Salinity:N_percent),.funs = as.numeric) %>% 
  mutate(cluster = if_else(cluster == 3, "Low", if_else(cluster == 2, "Mid", "High")))
mymeta <- rbind(V_meta,C_meta) %>% select(-adj_CT_depth_cm)

write_csv(mymeta, here("Data", "Biogeochem", "Cluster_metadata_FullSeasons_noseep.csv"))
```  


### Create Base Maps for Varari and Cabral
```{r}
# mean lat and long for the maps
MeanGPS <- Full_data %>%
  group_by(Location) %>% # varari vs cabral
  summarise(lon = median(lon, na.rm = TRUE),
            lat = median(lat, na.rm = TRUE))

SiteGPS <- Full_data %>%
  group_by(Location, CowTagID) %>%
  summarise(lon = mean(lon, na.rm = TRUE),
            lat = mean(lat, na.rm = TRUE))


# Varari
VarariBaseMap<-get_map(MeanGPS %>% filter(Location == "Varari") %>% select(lon,lat) %>% mutate(lon=lon+0.0001), maptype = 'satellite', zoom = 19)
# Cabral
CabralBaseMap<-get_map(MeanGPS %>% filter(Location == "Cabral") %>% select(lon,lat), maptype = 'satellite', zoom = 18)
```

### Show basemaps
```{r}
# Moorea
MooreaMap<-get_map('Moorea', maptype = 'satellite', zoom = 12)
MooreaMapPlot <- ggmap(MooreaMap) +
  geom_rect(data=MeanGPS, aes(xmin=lon[1] - 0.006, xmax=lon[1] + 0.006, ymin=lat[1] - 0.01, ymax=lat[1] + 0.01), color="white", alpha=0, size = 2) + # Cabral square
  geom_rect(data=MeanGPS, aes(xmin=lon[2] - 0.006, xmax=lon[2] + 0.006, ymin=lat[2] - 0.01, ymax=lat[2] + 0.01), color="white", alpha=0, size = 2) + # Varari square
  geom_point(data=MeanGPS, aes(x = lon, y = lat, label = Location), # adds star at center of Location
             shape = 18, color = "white", fill = "white", size = 8) +
  labs(x = "Longitude", y = "Latitude") +
  geom_text(data = MeanGPS, aes(label = Location), color = "white", hjust = -1, size = 10) + # adds Location names to the right of the boxes
  geom_segment(x = MeanGPS$lon[1] + 0.006, y = MeanGPS$lat[1], xend = MeanGPS$lon[1] + 0.023, yend = MeanGPS$lat[1], color = "white", size = 2) + # adds horizontal line from edge of box to Location name
  geom_segment(x = MeanGPS$lon[2] + 0.006, y = MeanGPS$lat[2], xend = MeanGPS$lon[2] + 0.023, yend = MeanGPS$lat[2], color = "white", size = 2)

MooreaMapPlot

ggsave(here("Output","Moorea_Map.png"),MooreaMapPlot,height = 10, width = 10)
```

```{r}
# Varari
VmapSites <- ggmap(VarariBaseMap) +
  geom_point(data = Full_data_csv,
             aes(x = lon, y = lat),
             color = "white",
             size = 2) + 
  labs(x = "Longitude", y = "Latitude",  #label x and y axes
        title = "Varari Sample Locations") +
  geom_label_repel(data = Full_data_csv,
             aes(x = lon, y = lat,
                 label = CowTagID),
             size = 2) 

#ggsave(here("Output","SGDZones","Varari","Varari_CowTagID_Map.png"),VmapSites,height = 10, width = 10)

# cabral
CmapSites <- ggmap(CabralBaseMap) +
  geom_point(data = Full_data_csv,
             aes(x = lon, y = lat),
             color = "white",
             size = 2) + 
  labs(x = "Longitude", y = "Latitude",  #label x and y axes
        title = "Cabral Sample Locations") +
  geom_label_repel(data = Full_data_csv,
             aes(x = lon, y = lat,
                 label = CowTagID),
             size = 2)

#ggsave(here("Output","SGDZones","Cabral","Cabral_CowTagID_Map.png"),CmapSites,height = 10, width = 10)

VmapSites + CmapSites
```


## Show clusters on maps
```{r}

## create palette
V_cluster_palette <- c("brown3", "white", "#fad02c") #1 is dark yellow #2 is baby blue #3 is red

  ### Map Varari clusters
VSeepPt <- Full_data_csv %>% filter(CowTagID == "VSEEP") # isolate Varari seep

cluster_varari_map <- ggmap(VarariBaseMap) +
  geom_point(data = V_Cluster_data,
             aes(x = lon, y = lat,
                 fill = V_cluster),
             shape = 21,
             color = "black",
             size = 3) + # set alpha and color aesthetics
  geom_point(data = VSeepPt, # star the seepage point
             aes(x = lon, y = lat),
             shape = 24,
             fill = "black",
             color = "white",
             size = 4) +
  # scale_color_manual(values = pnw_palette("Moth", 4)) +
  labs(x = "Longitude", y = "Latitude",  #label x and y axes
        title = "Varari, Clusters (LCM) \n Transformed and Scaled",
       fill = "Varari Clusters") +
  scale_fill_manual(values = V_cluster_palette)

cluster_varari_map

ggsave(here("Output","SGDZones","Varari",paste0("Varari_Cluster_Map_FullSeasons_noseep.png")),cluster_varari_map,height = 10, width = 10)

```

```{r}
## create palette
#C_cluster_palette <- c("#fad02c", "limegreen", "white", "brown3") # seep is red

  ### Map Cabral clusters
CSeepPt <- Full_data_csv %>% filter(CowTagID == "CSEEP") # isolate Varari seep

cluster_cabral_map <- ggmap(CabralBaseMap) +
  geom_point(data = C_Cluster_data,
             aes(x = lon, y = lat,
                 fill = C_cluster),
             shape = 22,
             color = "black",
            size = 3) + # set alpha and color aesthetics
    geom_point(data = CSeepPt, # star the seepage point
             aes(x = lon, y = lat),
             shape = 25,
             fill = "black",
             color = "white",
             size = 4) +
  # scale_color_manual(values = pnw_palette("Moth", 4)) +
  labs(x = "Longitude", y = "Latitude",  #label x and y axes
      title = "Cabral, Clusters (LCM) \n Transformed and Scaled",
       color = "Cabral Clusters") +
  scale_fill_manual(values = V_cluster_palette)

cluster_cabral_map

ggsave(here("Output","SGDZones","Cabral",paste0("Cabral_Cluster_Map_FullSeasons_noseep.png")),cluster_cabral_map,height = 10, width = 10)


```

*Triangles showing seepage points*

Save maps together
```{r, eval = F, echo = F}
  ### Map Varari clusters
cluster_varari_map_noLab <- ggmap(VarariBaseMap) +
  geom_point(data = V_Cluster_data,aes(x = lon, y = lat,fill = V_cluster),
             shape = 21,color = "black",size = 4) + 
  geom_point(data = VSeepPt, # star the seepage point
             aes(x = lon, y = lat),
             shape = 24,
             fill = "black",
             color = "white",
             size = 4) +
  # scale_color_manual(values = pnw_palette("Moth", 4)) +
  labs(x = "Longitude", y = "Latitude", fill = "Varari Clusters") +
  scale_fill_manual(values = V_cluster_palette) +
  labs(title = "Varari")
  ### Map Cabral clusters
cluster_cabral_map_noLab <- ggmap(CabralBaseMap) +
  geom_point(data = C_Cluster_data,aes(x = lon, y = lat,fill = C_cluster),
             shape = 22,color = "black",size = 4) + 
  geom_point(data = CSeepPt, # star the seepage point
             aes(x = lon, y = lat),
             shape = 25,
             fill = "black",
             color = "white",
             size = 4) +
  # scale_color_manual(values = pnw_palette("Moth", 4)) +
  labs(x = "Longitude", y = "Latitude", fill = "Cabral Clusters") +
  scale_fill_manual(values = C_cluster_palette) +
  labs(title = "Cabral")



ClusterMaps<-cluster_varari_map_noLab + cluster_cabral_map_noLab + 
  plot_layout(nrow = 1,
              guides = "collect") + # put both legends in same area of plot
  patchwork::plot_annotation(tag_levels = 'A',
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))
ClusterMaps

ggsave(plot = ClusterMaps, filename = here("Output","SGDZones","Cluster_Maps_FullSeasons_noseep.png"), width = 14, height = 10)
```


## Boxplots showing driving factors
```{r}

### Create boxplot faceted by clusters
#First, pivot longer
V_cluster_long <- V_Cluster_data %>%
  pivot_longer(cols = c(Salinity:N_percent),
               names_to = "Nutrient_parameters",
               values_to = "Nutrient_values")

Vbox<-ggplot(V_cluster_long, 
              mapping = aes(x = reorder_within(Nutrient_parameters,desc(Nutrient_values), V_cluster, sep = ": "), # tidytext::reorder_within allows reordering while using facet_wrap if scales = 'free_x'
                            y= Nutrient_values, 
                            color = V_cluster)) +
  geom_boxplot(fill = "azure4")+
  facet_wrap(~V_cluster, scales = "free_x", nrow = 1) +
  ylab("Concentration") +
  xlab("") +
  labs(color = "Varari Clusters") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = -.1),
        panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank()) +
  scale_color_manual(values = V_cluster_palette)
Vbox


ggsave(here("Output","SGDZones","Varari",paste0("Boxplots_Varari_FullSeasons_noseep.png")), Vbox, height = 20, width = 8)
```

```{r}
C_cluster_long <- C_Cluster_data %>%
  pivot_longer(cols = c(Salinity:N_percent),
               names_to = "Nutrient_parameters",
               values_to = "Nutrient_values")

Cbox<-ggplot(C_cluster_long, 
              mapping = aes(x = reorder_within(Nutrient_parameters,desc(Nutrient_values), C_cluster, sep = ": "),
                            y= Nutrient_values, 
                            color = C_cluster)) +
  geom_boxplot(fill = "azure4")+
  facet_wrap(~C_cluster, scales = "free_x", nrow = 1) +
  ylab("Concentration") +
  xlab("") +
  labs(color = "Cabral Clusters") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = -.1),
        panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank()) +
  scale_color_manual(values = V_cluster_palette)
Cbox


ggsave(here("Output","SGDZones","Cabral",paste0("Boxplots_Cabral_FullSeasons_noseep.png")), Cbox, height = 20, width = 8)
```

```{r, eval = F, echo = F}
# cluster together
ClusterBoxPlots<-Vbox + Cbox + 
  plot_layout(nrow = 2,
              guides = "collect") + # put both legends in same area of plot
  patchwork::plot_annotation(tag_levels = 'A',
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))
ClusterBoxPlots

ggsave(plot = ClusterBoxPlots, filename = here("Output","SGDZones","Cluster_BoxPlots.png"), width = 10, height = 14)

```



## PCA for clustering
```{r}
# V_Cluster_data
# C_Cluster_data

# extract parameters for the PCA
V_pca_data <-V_Cluster_data %>% 
  select(-c(Location:adj_CT_depth_cm),-V_cluster)

C_pca_data <-C_Cluster_data %>% 
  select(-c(Location:adj_CT_depth_cm),-C_cluster)

# Run the PCA
pca_V <- prcomp(V_pca_data, na.action=na.omit) # , scale. = TRUE, center = TRUE) # data is already scaled and centered
pca_C <- prcomp(C_pca_data %>% drop_na()) # na.omit was not working

# Extract the scores and loadings
PC_scores_V <-as_tibble(pca_V$x[,1:2])
PC_loadings_V<-as_tibble(pca_V$rotation) %>%
  bind_cols(labels = rownames(pca_V$rotation))

PC_scores_C <-as_tibble(pca_C$x[,1:2])
PC_loadings_C<-as_tibble(pca_C$rotation) %>%
  bind_cols(labels = rownames(pca_C$rotation))

# Put it with all the original data
V_pca_data_all<-V_Cluster_data %>%
  bind_cols(PC_scores_V)

C_pca_data_all<-C_Cluster_data %>%
  drop_na() %>%  # remove same row as above
  bind_cols(PC_scores_C)
```

## scores plot
```{r}
p1_V<-V_pca_data_all %>%
  ggplot(aes(x = PC1, 
             y = PC2, 
             fill = V_cluster))+
  geom_point(shape = 21,
             color = "white",
             size = 3) +
  coord_cartesian(xlim = c(-6, 5), ylim = c(-5, 5)) +
  #scale_shape_manual(values = c(22,16))+
  scale_colour_hue(l = 45)+ # l: luminance/lightness 0-100
  scale_fill_hue(l = 45)+ 
  scale_fill_manual(values = V_cluster_palette) +
  ggforce::geom_mark_ellipse(
    aes(fill = V_cluster, label = V_cluster), 
    alpha = .15, show.legend = FALSE,  label.buffer = unit(1, "mm"))+
  theme_bw()+
  theme(legend.position = "none", panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(title = "Varari Scores Plot") +
  geom_text_repel(aes(label = CowTagID), size = 2)
p1_V
```

```{r}
p1_C<-C_pca_data_all %>%
  ggplot(aes(x = PC1, 
             y = PC2, 
             fill = C_cluster))+
  geom_point(shape = 21,
             color = "white",
             size = 3) +
  coord_cartesian(xlim = c(-6, 6), ylim = c(-5, 5)) +
  #scale_shape_manual(values = c(22,16))+
  scale_colour_hue(l = 45)+ # l: luminance/lightness 0-100
  scale_fill_hue(l = 45)+ 
  scale_fill_manual(values = V_cluster_palette) +
  ggforce::geom_mark_ellipse(
    aes(fill = C_cluster, label = C_cluster), 
    alpha = .15, show.legend = FALSE,  label.buffer = unit(1, "mm"))+
  theme_bw()+
  theme(legend.position = "none", panel.background = element_rect(fill = "azure4"),
        panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(title = "Cabral Scores Plot") +
  geom_text_repel(aes(label = CowTagID), size = 2)

p1_C
#p1_V / p1_C # patchwork plot

```

## loadings plot
```{r}
# loadings plot 
p2_V<-PC_loadings_V %>%
  ggplot(aes(x=PC1, y=PC1, label=labels))+ # labels are the parameters
    geom_segment(aes(x=0,y=0,xend=PC1*10,yend=PC2*10),
      arrow=arrow(length=unit(0.1,"cm")), color = "grey")+
  annotate("text", x = PC_loadings_V$PC1*10+0.1, y = PC_loadings_V$PC2*10+.1,
           label = PC_loadings_V$labels)+
  coord_cartesian(xlim = c(-6, 7), ylim = c(-5, 8)) +
   theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  labs(title = "Varari Loadings")

p2_V

VarariPCA<-p1_V+p2_V+ 
  patchwork::plot_annotation(#"Varari Clusters", 
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))
ggsave(plot = VarariPCA, filename = here("Output","SGDZones","Varari","VarariPCA_FullSeasons_noseep.png"), width = 14, height = 8)

```

```{r}
p2_C<-PC_loadings_C %>%
  ggplot(aes(x=PC1, y=PC1, label=labels))+ # labels are the parameters
    geom_segment(aes(x=0,y=0,xend=PC1*10,yend=PC2*10),
      arrow=arrow(length=unit(0.1,"cm")), color = "grey")+
  annotate("text", x = PC_loadings_C$PC1*10+0.1, y = PC_loadings_C$PC2*10+.1,
           label = PC_loadings_C$labels)+
  coord_cartesian(xlim = c(-6, 4), ylim = c(-6, 7)) +
   theme_bw()+
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+
  labs(title = "Cabral Loadings")

p2_C

CabralPCA<-p1_C+p2_C+ 
  patchwork::plot_annotation(#"Cabral Clusters", 
                             theme = theme(plot.title = element_text(size = rel(1.5), 
                                                                     face = "bold", 
                                                                     hjust = 0.5, 
                                                                     margin = margin(t = 10, b = 20,
                                                                                     unit = "pt"))))


ggsave(plot = CabralPCA, filename = here("Output","SGDZones","Cabral","CabralPCA_FullSeasons_noseep.png"), width = 14, height = 8)

```


