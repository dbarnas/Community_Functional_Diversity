---
title: "Natural Environmental Gradients Alter Community Composition and Functional Diversity on Coral Reefs"
author: "Danielle Barnas"
date: "2023-06-15"
output: html_document
---

```{r setup, include=FALSE, warning = FALSE, message = FALSE, comment = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## The second chapter of Danielle Barnas's thesis to fulfill a  Masters of Science in Biology at CSU Northridge

### TOC:
- Figure 1  
    - A: [Map of Moorea](#MooreaMap)
    - B: [Map of survey locations at Varari](#SurveyMap)

- [Figure 2](#DeltaAIC): Delta corrected AIC values for models testing SGD parameter influence on community diversity metrics (species richness, functional entity richness, and functional entity volume).  

- [Figure 3](#PO4Regressions)  
    - Scatter plots displaying polynomial regressions of the coefficient of variation of phosphate (µmol/L) against community diversity metrics (species richness, functional entity richness, and functional entity volume).  

- [Figure 4](#Fgroup): Bar plots of percent cover for functional traits within each functional group at survey locations, arranged by increasing coefficient of variation of phosphate (µmol/L).  
    
- Figure 5
    - A: [FEV PCoA](#FEVpcoa): PCoA analysis of functional entity presence at each survey location along the SGD gradient, colored and arranged by increasing coefficient of variation of phosphate (µmol/L).
    - B: [Trait PCoA](#Traitpcoa): Traits from each functional entity displayed by functional groups along PCoA axes. 
- [Figure 6](#ANOSIM): Pairwise scatter plot displaying linear regressions of dissimilarity matrices: SGD parameters on community composition along the reef, calculated from an analysis of similarity (ANOSIM).

    
- [Table 1](#TermTable): List of terms and symbols
    
- [Table 2](#TraitTable): Functional traits within functional group categories used to classify species by their role in community ecosystem functioning.  

- [Supp Table 1](#TaxaTable): List of identified taxa and their associated functional traits; reference literature or database sources for each species-trait categorization are provided.  

- [Supp Table 2](#AICTable): Delta corrected AIC values for models testing SGD parameter influence on community diversity metrics (species richness, functional entity richness, and functional entity volume).  

- [Supp Figure 1](#ReefSGD): Coefficient of variation of physicochemical parameters used in model selection are displayed in a scatter plot as points from survey locations across the reef colored by CV phosphate (PO43-) behind the black point showing parameter mean (SE).

- Supp Figure 2: 
    - [A: ](#Rugosity_SGD) Scatter plots displaying polynomial regressions of the coefficient of variation of SGD parameters used for model testing against rugosity (A). 
    - [B: ](#Diversity_Rugosity) Linear regression of relationship between diversity metrics and rugosity.

- [Supp Figure 3](#CVNutrients): Scatter plots displaying linear regressions of the coefficient of variation of silicate and salinity on CV nitrate+nitrite and phosphate.

- [Supp Figure 4](#LMFunctionalTraits): Scatter plots displaying linear and polynomial regressions of individual functional traits within groups relative to increasing CV phosphate (µmol/L).

- [Supp Figure 5](#FE_Sp_ratio): Relationship of functional entity richness to species richness along the gradient of CV phosphate (µmol/L), with and without the seepage point.

- [Supp Figure 6](#Substrate): Bar plot displaying proportional substrate cover at each survey location, arranged by increasing coefficient of variation of phosphate (µmol/L).





<a name = "MooreaMap"></a>

### Figure 1A: Map of Moorea

```{r}

```




<a name = "SurveyMap"></a>

### Figure 1B: Map of Moorea survey locations

```{r}

```


<a name = "Diagram"></a>

### Figure 1C: Community diversity example diagram

```{r}

```



<a name = "DeltaAIC"></a>

### Figure 2: Delta AIC

```{r, AICplot}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(PNWColors)
#library(tidytext)
#library(AICcmodavg)


###############################
# READ IN DATA
###############################
modelTable <- read_csv(here("Output", "PaperFigures","Model_Selection_Table.csv"))



###############################
# PROCESS DATA
###############################
modelTableData <- modelTable %>%
  group_by(Y) %>%
  mutate(Y = if_else(Y == "resSpp", "% SR (res)",
             if_else(Y == "resFEp", "% FER (res)",
             if_else(Y == "resVol", "% FEV (res)",
             if_else(Y == "NbSpP", "% SR",
             if_else(Y == "NbFEsP", "% FER",
             if_else(Y == "Vol8D", "% FEV", Y)))))),
         Y = factor(Y, levels = c('% SR', '% FER', '% FEV', '% SR (res)', '% FER (res)', '% FEV (res)')),
         #Parameter = if_else(Parameter == "meanRugosity", "Rugosity", Parameter),
         Reg_Type = factor(Reg_Type, levels = c("Polynomial", "Linear")),
         Parameter = factor(Parameter,
                            levels = c("Rugosity", "Phosphate", "Nitrate+Nitrite", "pH", "Salinity", "Silicate", "Temperature",
                                       "Phosphate + Rugosity", "Nitrate+Nitrite + Rugosity", "pH + Rugosity", "Salinity + Rugosity", "Silicate + Rugosity", "Temperature + Rugosity"))) %>%
  mutate(minAICc = min(AICc),
         deltaAICc = AICc - minAICc)

```
```{r}
###############################
# VISUALIZEE
###############################
mypal <- pnw_palette("Starfish", n = 2)

# raw models
AICplot <- modelTableData %>%
  filter(Y== "% SR" | Y == "% FER" | Y== "% FEV") %>%
  ggplot(aes(x = deltaAICc, y = fct_reorder(Parameter, desc(Parameter)), fill = Reg_Type)) +
  geom_col(position = "dodge", color = "black") +
  facet_wrap(~Y) +
  labs(x = expression(Delta*"AICc"),
       y= "Parameters",
       fill = "Regression") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(size = 10),
        legend.position = "top",
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.grid = element_blank(),
        axis.text = element_text(size = 10),
        axis.title.y = element_blank(),
        axis.title.x = element_blank()) +
  scale_fill_manual(values = mypal) +
  geom_vline(xintercept = 2, linetype = "dashed", size = 0.7)
  
# residual models
AICplotres <- modelTableData %>%
  filter(Y== "% SR (res)" | Y == "% FER (res)" | Y== "% FEV (res)") %>%
  ggplot(aes(x = deltaAICc, y = fct_reorder(Parameter, desc(Parameter)), fill = Reg_Type)) +
  geom_col(position = "dodge", color = "black") +
  facet_wrap(~Y) +
  labs(x = expression(Delta*"AICc"),
       y= "Parameters",
       fill = "Regression") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(size = 10),
        legend.position = "top",
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        panel.grid = element_blank(),
        axis.text = element_text(size = 10),
        axis.title.y = element_blank(),
        axis.title.x = element_text(size = 14)) +
  scale_fill_manual(values = mypal) +
  geom_vline(xintercept = 2, linetype = "dashed", size = 0.7)

# patch
AICplotAll <- AICplot / AICplotres +
  plot_annotation(tag_levels = "A") +
  plot_layout(guides = 'collect') & theme(legend.position = 'top')

AICplotAll
```



<a name = "PO4Regressions"></a>

### Figure 3: Polynomial regressions

```{r, rugosityplot}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(MuMIn)
library(tidytext)



###############################
# READ IN DATA
###############################
Fric <- read_csv(here("Data", "Sp_FE_Vol.csv"))
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
meta <- read_csv(here("Data", "Full_Metadata.csv"))
chem <- read_csv(here("Data","Biogeochem", "Nutrients_Processed_All.csv")) %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  filter(CowTagID != "VSEEP") %>%
  select(CowTagID, Parameters, CVSeasonal) %>%
  pivot_wider(names_from = Parameters, values_from = CVSeasonal)
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))


### Join Sp and FE and Vol4D with metadata
reg.Fric <- resFric %>%
  as_tibble() %>%
  left_join(meta) %>%
  filter(CowTagID != "VSEEP" &
           CowTagID != "V13")





###############################
# VISUALIZE
###############################
resFric <- reg.Fric %>%
  left_join(chem)


plotfun <-function(data = resFric %>% left_join(alphatag), y){

  y <- enquo(y)

  plota <- data %>%
    ggplot(aes(x = Phosphate_umolL,
               y = !!y)) +
    geom_point(size = 2.5) +
    geom_smooth(method = "lm", formula = "y~poly(x,2)", color = "black") +
    theme_bw() +
    theme(axis.title = element_text(size = 13),
          axis.text = element_text(size = 12)) +
    theme(panel.grid.major = element_blank(),
          #axis.title.y = element_blank(),
          axis.text.x = element_text(hjust = 1)) +
    labs(x = "")

  return(plota)

}

## Relative non-normalized richness
rug_SpR_plot <- plotfun(y = NbSpP) +
  labs(y = "% SR") +
  theme(axis.title.x = element_blank()) +
  ylim(min = 0, max = 100)

rug_FER_plot <- plotfun(y = NbFEsP) +
  labs(y = "% FER") +
  theme(axis.title.x = element_blank()) +
  ylim(min = 0, max = 100)

rug_Vol_plot <- plotfun(y = Vol8D) +
  labs(y = "% FEV") +
  theme(axis.title.x = element_blank()) +
  ylim(min = 0, max = 100)

rugosityplot <- rug_SpR_plot + rug_FER_plot + rug_Vol_plot

```
```{r, eval = FALSE}
### p values
summary(lm(data = resFric, resSpp ~ poly(Phosphate_umolL,2)))
summary(lm(data = resFric, resFEp ~ poly(Phosphate_umolL,2)))
summary(lm(data = resFric, resVol ~ poly(Phosphate_umolL,2)))

```
```{r, rugosityresplot}
## Relative richness and volume residuals
rug_res_SpRp_plot <- plotfun(y = resSpp) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "% SR residuals",
       x = "")

rug_res_FERp_plot <- plotfun(y = resFEp) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "% FER residuals",
       x = expression("CV Phosphate ("*mu*"mol/L)"))

rug_res_Vol_plot <- plotfun(y = resVol) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  labs(y = "% FEV residuals",
       x = "")

rugosityresplot <- rug_res_SpRp_plot + rug_res_FERp_plot + rug_res_Vol_plot

```
```{r, divPlots}
divPlots <- rugosityplot / rugosityresplot +
  plot_annotation(tag_levels = 'A')
divPlots
```






<a name = "FEVpcoa"></a>

### Figure 4A: PCoA of functional entities at each survey location, arranged by increasing CV phosphate

```{r}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)



###############################
# READ IN DATA
###############################
resFric <- read_csv(here("Data","Sp_FE_Vol_res.csv"))
speciesfe <- read_csv(here("Data", "Species_FE.csv"))
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))
coord <- read_csv(here("Data", "FE_4D_coord_dmb.csv")) %>% rename(FE = `...1`)
com <- read_csv(here("Data", "Species_Abundances_wide.csv"))
fe <- read_csv(here("Data", "Distinct_FE.csv"))



###############################
# ANALYZE DATA
###############################
fedata <- coord %>% 
  left_join(fe)


```
```{r, eval = FALSE}
anova(lm(data = fedata, PC1 ~ Taxon_Group)) # 8.9e-12
anova(lm(data = fedata, PC2 ~ Taxon_Group)) # 0.027

anova(lm(data = fedata, PC1 ~ Morph2)) # 0.33
anova(lm(data = fedata, PC2 ~ Morph2)) # 0.09

anova(lm(data = fedata, PC1 ~ Calc)) # 2.4e-8
anova(lm(data = fedata, PC2 ~ Calc)) # 0.00010
summary(lm(data = fedata, PC2 ~ Calc)) # 0.00010

anova(lm(data = fedata, PC1 ~ ER)) # <2.2e-16
summary(lm(data = fedata, PC1 ~ ER)) # <2.2e-16
anova(lm(data = fedata, PC2 ~ ER)) # 0.16

```
```{r, eval = F, echo = F}
###############################
# PERMANOVA ON PRESENCE/ABSENCE
###############################
library(vegan) # nMDS and permanova
library(pairwiseAdonis)


#### PREP DATA FOR MODEL
VarResFric <- resFric %>%
  left_join(alphatag) %>%
  select(AlphaTag, Vol8D)
low <- VarResFric %>%
  filter(AlphaTag == "B" | AlphaTag == "F" | AlphaTag == "E" | AlphaTag == "Q") %>%
  mutate(Varcat = "Low")
high <- VarResFric %>%
  filter(AlphaTag == "D" | AlphaTag == "C" | AlphaTag == "N" | AlphaTag == "H") %>%
  mutate(Varcat = "High")
LH <- rbind(low,high)
VarResFric <- VarResFric %>%
  filter(AlphaTag != "A-Seep") %>%
  left_join(LH) %>%
  mutate(Varcat = if_else(is.na(Varcat), "Moderate", Varcat))



# permanovamodel<-adonis(VarResFric[,-1]~AlphaTag, VarResFric, permutations = 999, 
#                        method="bray")
# permanovamodel
# 
# #assume that the dispersion among data is the same in each group. We can test with assumption with a PermDisp test:
# disper<-vegdist(data_nmds[,-1])
# betadisper(disper, PercentTotal$Site)
# #Look at the Average distance to median...these numbers should be reasonably similar
# #A rule of thumb is that one number should not be twice as high as any other
# 
# #An option for doing post-hoc pairwise comparisons in R
# library(pairwiseAdonis)
# pairwise.adonis(PercentTotal[-1], PercentTotal$Site, perm=999)
# 
# 
# 
# ## CHECK ASSUMPTIONS 
# distances <- vegdist(ab.sgd, distance = 'bray')
# 


```






<a name = "Traitpcoa"></a>

### Figure 4B: PCoA of functional entities, traits displayed within functional groups

```{r}

```





<a name = "Fgroup"></a>

### Figure 5: Bar plot of functional trait abundance along SGD gradient

```{r}

```




<a name = "TermTable"></a>

### Table 1: List of terms and symbols

```{r}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(kableExtra)


###############################
# READ IN DATA
###############################
terms <- read_csv(here("Data", "List_of_terms.csv"))



###############################
# CREATE TABLE
###############################
TermTable <- terms %>% 
  kbl() %>% 
  kable_styling(html_font = "Times New Roman",
                font_size = 20, 
                #bootstrap_options = "bordered", 
                full_width = FALSE) %>% 
  column_spec(1, border_right = T, 
              background = "white", # beige
              color = "black") %>% 
  column_spec(2, background = "white",
              color = "black",
              width_max = "25em") %>% 
  row_spec(0, italic = TRUE, bold = TRUE, background = "white", hline_after = TRUE, color = "black", extra_css = "border-bottom: 1px solid;") %>% 
  row_spec(seq(1, nrow(terms)), extra_css = "border-bottom: 1px solid;")

TermTable
```
```{r, eval=FALSE}
TermTable %>% 
  as_image(file = here("Output", "Thesis_Figures_Output", "TermTable.png"))
```





<a name = "TraitTable"></a>

### Table 2: Table of functional traits in categorical groups

```{r}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)

# For dev version
#devtools::install_github("haozhu233/kableExtra", force = TRUE)
library(kableExtra)


###############################
# READ IN DATA
###############################
fgroups <- read_csv(here("Data", "Table1_functional_groups_dmb.csv"))



###############################
# PROCESS FOR TABLE
###############################
fgroups <- fgroups %>% 
  select(Morphology:`Energetic Resource`) %>% 
  mutate_at(.vars = vars(Phyla:`Energetic Resource`), 
            .funs = ~if_else(is.na(.), " ", .))



###############################
# CREATE TABLE
###############################
TraitTable <- fgroups %>% 
  kbl() %>% 
  kable_classic(html_font = "Times New Roman",
                font_size = 20) %>% 
  row_spec(0, italic = TRUE, bold = TRUE) %>% 
  column_spec(1:4, background = "white")

TraitTable
```
```{r, eval = FALSE}
TraitTable %>% 
  as_image(file = here("Output", "Thesis_Figures_Output", "TraitTable.png"))
```




<a name = "TaxaTable"></a>

### Supplemental Table 1: Table of identified taxa with associated functional traits and references

```{r}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(kableExtra)


###############################
# READ IN DATA
###############################
species <- read_csv(here("Data", "Species_FE.csv"))
abund <- read_csv(here("Data", "Species_Abundances_wide.csv"))


###############################
# PROCESS FOR TABLE
###############################
inTaxa <- abund %>% 
  pivot_longer(cols = 2:ncol(abund), names_to = "Taxa", values_to = "Values") %>% 
  distinct(Taxa)

species <- species %>% 
  right_join(inTaxa) %>%  # make sure we only have species from Varari
  separate(FE, into = c("Phyla", "Morphology", "Calcification", "Energetic Resrouce")) %>% 
  mutate(Taxa = if_else(Taxa == "Montipora efflorescans", "Montipora grisea",
                if_else(Taxa == "Grey Sponge", "Porifera 1", 
                if_else(Taxa == "Cyanobacteria", "Cyanobacteria 1", Taxa)))) %>% 
  rename(Species = Taxa)

speciesTable <- species %>% 
  kbl() %>% 
  kable_classic(html_font = "Times New Roman",
                font_size = 20) %>% 
  row_spec(0, italic = TRUE, bold = TRUE) %>%  # header row
  column_spec(1, italic = TRUE) %>% 
  column_spec(1:5, background = "white")

speciesTable
```
```{r, eval = FALSE}
speciesTable %>% 
  as_image(file = here("Output", "Thesis_Figures_Output", "SpeciesTable.png"))
```





<a name = "AICTable"></a>

### Supplemental Table 2: Table of Delta corrected AIC values

```{r, AICtable}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(kableExtra)


###############################
# READ IN DATA
###############################
modelTable <- read_csv(here("Output", "PaperFigures","Model_Selection_Table.csv"))
#modelTable_rug <- read_csv(here("Output", "PaperFigures","Model_Selection_Table_rugosity.csv"))


modTable <- modelTable %>%  
  rename(pVal = pVal.P) %>% 
  mutate(AICc = round(AICc, 1)) %>% 
  mutate(delAICc = round(delAICc, 1)) %>% 
  mutate(R2 = if_else(R2 > 0.1, round(R2,2), round(R2, 3))) %>% 
  mutate(pVal = signif(pVal, 2)) %>% 
  rename(Regression = Reg_Type,
         p = pVal,
         'Delta AICc' = delAICc) %>% 
  separate(col=Parameter, into = c("Parameter", NA), sep = " +") %>% 
  mutate(Parameter = if_else(Parameter == "Phosphate_umolL", "Phosphate", 
                             if_else(Parameter == "Silicate_umolL", "Silicate",
                                     if_else(Parameter == "NN_umolL", "Nitrate+Nitrite", Parameter)))) %>% 
  mutate(Y = factor(Y, levels = c("NbSpP", "NbFEsP", "Vol8D", "resSpp", "resFEp", "resVol")),
         Parameter = factor(Parameter,
                            levels = c("Rugosity", "Phosphate", "Nitrate+Nitrite", "pH", "Salinity", "Silicate", "Temperature"))) %>% 
                                       #"Phosphate:Rugosity", "Nitrate+Nitrite:Rugosity", "pH:Rugosity", "Salinity:Rugosity", "Silicate:Rugosity", "Temperature:Rugosity"))) %>% 
  arrange(Y,Parameter) 
```
```{r}
###############################
# RAW DATA TABLE
###############################
AICtable <- modTable %>%
  filter(Y== "NbSpP" | Y== "NbFEsP" | Y == "Vol8D") %>%
  select(-Y) %>% 
  kbl() %>% 
  kable_classic(html_font = "Times New Roman",
                font_size = 20) %>% 
  row_spec(0, italic = TRUE, bold = TRUE) %>%  # header row
  pack_rows("% SR", 1, 14) %>%
  pack_rows("% FER", 15, 28) %>%
  pack_rows("% FEV", 29, 42) %>%
  column_spec(1:6, background = "white")

AICtable
```
```{r, eval = FALSE}
AICtable %>% 
  as_image(file = here("Output", "Thesis_Figures_Output", "AICtable.png"))
```
```{r}
###############################
# RESIDUAL DATA TABLE
###############################
AICtable_residuals <- modTable %>%
  filter(Y== "resSpp" | Y== "resFEp" | Y == "resVol") %>%
  select(-Y) %>% 
  kbl() %>% 
  kable_classic(html_font = "Times New Roman",
                font_size = 20) %>% 
  row_spec(0, italic = TRUE, bold = TRUE) %>%  # header row
  pack_rows("% SR (residuals)", 1, 14) %>%
  pack_rows("% FER (residuals)", 15, 28) %>%
  pack_rows("% FEV (residuals)", 29, 42) %>%
  column_spec(1:6, background = "white")
```
```{r, eval = FALSE}
AICtable_residuals %>% 
  as_image(file = here("Output", "Thesis_Figures_Output", "AICtable_residuals.png"))
```







<a name = "ReefSGD"></a>

### Supplemental Figure 1: SGD along the reef 

```{r}
############################
### LOAD LIBRARIES
############################
library(tidyverse)
library(here)
library(kableExtra)
library(curl)
library(lubridate)
library(plotrix)
library(PNWColors)
library(patchwork)




############################
### READ IN DATA
############################
chem <- read_csv(here("Data", "Biogeochem", "Nutrients_Processed_All.csv"))
alpha <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))
AugChemData<-read_csv(curl('https://raw.githubusercontent.com/njsilbiger/MooreaSGD_site-selection/main/Data/August2021/Allbiogeochemdata_QC.csv'))


############################
### CLEAN RAW AUGUST DATA FOR MAX MIN
############################
# Remove outliers / irrelevant data points
removeSite1 <- AugChemData %>%
  filter(CowTagID == "V2",
         Tide == " Low",
         Day_Night == "Day",
         Date == ymd("2021-08-08"))

removeSite2 <- AugChemData %>%
  filter(CowTagID == "C4",
         Tide =="Low",
         Day_Night == "Night",
         Date == ymd("2021-08-09"))

## Filter out redundant low tide day sample, first 'low tide' was super high
removeSite3 <- AugChemData %>%
  filter(Tide == "Low",
         Day_Night == "Day",
         Date == ymd("2021-08-06"))

removeSite5 <- AugChemData %>%
  filter(CowTagID %in% c("VSPRING", "Varari_Well", "CSPRING"))


AugChem <- AugChemData %>%
  select(-c(Date,
            Time,
            DateTime,
            Plate_Seep,
            Top_Plate_ID,
            Bottom_Plate_ID,
            Jamie_Plate_ID,
            #Temperature,
            # Craig recommends to remove "because we don't hypothesize them to be
            # orthogonal to any of the other fDOM we're using"
            MarineHumic_Like, Lignin_Like)) %>%
  anti_join(removeSite1) %>% # remove outlier/irrelevant data
  anti_join(removeSite2) %>%
  anti_join(removeSite3) %>%
  anti_join(removeSite5) %>% 
  filter(Ammonia_umolL < 16)


max_data <- AugChem %>%
  group_by(Location, CowTagID) %>%
  summarise_at(vars(Salinity:Tyrosine_Like), .funs = max, na.rm = T) %>%  # select for max values
  pivot_longer(cols = Salinity:Tyrosine_Like, names_to = "Parameters", values_to = "Maximum")

min_data <- AugChem %>%
  group_by(Location, CowTagID) %>%
  summarise_at(vars(Salinity:Tyrosine_Like), .funs = min, na.rm = T) %>%  # select for max values
  pivot_longer(cols = Salinity:Tyrosine_Like, names_to = "Parameters", values_to = "Minimum")

# join max and min values and other data sets
mm_data <- full_join(max_data, min_data)

onlyParam <- AugChem %>% 
  select(Salinity:Ammonia_umolL)
onlyParam <- colnames(onlyParam)


############################
### PREP DATA FOR FIGURE
############################

dataChem <- chem %>% 
  filter(Season == "Dry") %>% 
  right_join(alpha) %>% 
  select(-c(Maximum, Minimum)) %>% 
  left_join(mm_data) %>% 
  select(-c(Location, lat, lon, Season, Range, MeanAll, CVAll)) %>% 
  relocate(AlphaTag, .before = Parameters) %>% 
  select(-CowTagID) %>% 
  filter(Parameters %in% onlyParam) %>% 
  filter(Parameters != "TA" &
           Parameters != "Ammonia_umolL")

tabData <- dataChem %>% 
  mutate(Location = if_else(AlphaTag == "A", "Seep", "Reef")) %>% 
  pivot_longer(cols = c(Minimum, Maximum, MeanSeasonal, CVSeasonal), names_to = "MeanParam", values_to = "MeanVal") %>%
  group_by(Parameters, Location, MeanParam) %>%
  mutate(AllMean = mean(MeanVal),
         SE = std.error(MeanVal)) %>% 
  mutate(MeanParam = if_else(MeanParam == "MeanSeasonal", "Mean", 
                     if_else(MeanParam == "Maximum", "Max",
                     if_else(MeanParam == "Minimum", "Min",
                     if_else(MeanParam == "CVSeasonal", "CV", MeanParam))))) %>% 
  mutate(Parameters = if_else(Parameters == "NN_umolL", "Nitrate+Nitrite",
                     if_else(Parameters == "Phosphate_umolL", "Phosphate",
                     if_else(Parameters == "Silicate_umolL", "Silicate", Parameters))))
```
```{r, echo = FALSE, eval = FALSE}
mypal <- pnw_palette("Starfish", n=7)[c(4, 7)]

AugChem %>% 
  mutate(Location = if_else(CowTagID == "VSEEP", "Seep", "Reef")) %>% 
  select(CowTagID:Day_Night,Location,
         Silicate_umolL, Phosphate_umolL, NN_umolL,
         Salinity, pH, Temperature) %>% 
  rename(Silicate = Silicate_umolL, `Nitrate+Nitrite` = NN_umolL, Phosphate = Phosphate_umolL) %>% 
  pivot_longer(cols = Silicate:Temperature, names_to = "Param", values_to = "values") %>% 
  group_by(Param, Location) %>% 
  summarise(mean = mean(values, na.rm = T),
            min = min(values, na.rm = T),
            max = max(values, na.rm = T),
            se = std.error(values, na.rm = T)) %>% 
  rename(Min = min, Max = max, Mean = mean) %>% 
  pivot_longer(cols = c(Mean:Max), names_to = "metric", values_to = "values") %>% 
  mutate(se = if_else(metric == "Mean", se, 0)) %>% 
  
  
  ggplot(aes(x = metric, y = values, color = Location)) +
  geom_point(size = 3) +
  geom_errorbar(aes(ymin = values-se, ymax = values+se), width = 0.1) +
  theme_classic() +
  theme(strip.background = element_rect(fill = "white"),
        axis.title = element_blank(),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 10),
        axis.ticks.x = element_blank()) +
  scale_color_manual(values = mypal) +
  facet_wrap(~Param, scales = "free_y")
  
```

```{r}
mypal <- pnw_palette("Starfish", n=19)
mypal2 <- pnw_palette("Starfish", n=7)[5]

myPhos <- dataChem %>% 
  select(AlphaTag, Parameters,CVSeasonal) %>% 
  filter(Parameters == "Phosphate_umolL") %>% 
  pivot_wider(names_from = Parameters, values_from = CVSeasonal)

cvreef <- tabData %>% 
  left_join(myPhos) %>% #will color by phosphate
  filter(Location == "Reef") %>%
  mutate(Parameters = factor(Parameters, levels = c("Nitrate+Nitrite","Silicate","Phosphate","Salinity", "pH", "Temperature"))) %>% 
  filter(MeanParam == "CV") %>% 
  ggplot(aes(x = MeanParam, y = AllMean)) +
  # raw points
  geom_point(aes(x = MeanParam, y = MeanVal, color = Phosphate_umolL),
             alpha = 0.6, position = position_jitter(width = 0.2)) +
  # primary points
  geom_point(aes(x = MeanParam, y = AllMean), color = "black", size = 3) +
  geom_errorbar(aes(ymin = AllMean-SE, ymax = AllMean+SE), width = 0.1) +
  labs(y = "Coefficient of Variation of \nphysicochemical variables", color = expression("CV Phosphate ("*mu*"mol/L)")) +
  theme_classic() +
  theme(strip.background = element_rect(fill = "white"),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),
        axis.text.x = element_blank(),
        axis.text.y = element_text(size = 10),
        axis.ticks.x = element_blank()) +
  scale_color_gradientn(colors = mypal) +
  #scale_color_manual(values = mypal2) +
  facet_wrap(~Parameters, scales = "free_y") 
  #plot_annotation(tag_levels=list(c('C')))
cvreef
```
```{r, eval = FALSE}
ggsave(here("Output", "PaperFigures", "Fig2_Reef_CV_Biogeochem.png"), cvreef, device = "png", height = 5, width = 7)
```





### Supplemental Figure 2: 

```{r, rugPlot}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(MuMIn)
library(tidytext)



###############################
# READ IN DATA
###############################
Fric <- read_csv(here("Data", "Sp_FE_Vol.csv"))
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
meta <- read_csv(here("Data", "Full_Metadata.csv"))
chem <- read_csv(here("Data","Biogeochem", "Nutrients_Processed_All.csv")) %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  filter(CowTagID != "VSEEP") %>%
  select(CowTagID, Parameters, CVSeasonal) %>%
  pivot_wider(names_from = Parameters, values_from = CVSeasonal)
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))


### Join Sp and FE and Vol4D with metadata
reg.Fric <- resFric %>%
  as_tibble() %>%
  left_join(meta) %>%
  filter(CowTagID != "VSEEP" &
           CowTagID != "V13") %>% 
  mutate(meanRugosity = 1-meanRugosity)




###############################
# RESIDUAL MODELS (~ RUGOSITY)
###############################
resFric <- reg.Fric %>%
  left_join(chem)
```



<a name = "Rugosity_SGD"></a>

### Supplemental Figure 2a:

```{r, Supp2A}
supp2A <- resFric %>%
  rename('N+N (umol/L)' = NN_umolL, 'Phosphate (umol/L)' = Phosphate_umolL,
         'Silicate (umol/L)' = Silicate_umolL, 'Temperature (C)' = Temperature) %>%
  select(-TA) %>%
  pivot_longer(cols = c(Salinity:'N+N (umol/L)'), names_to = "Parameters", values_to = "Values") %>%
  ggplot(aes(x = Values, y = meanRugosity)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x", color = "black") +
  geom_smooth(method = "lm", formula = "y~poly(x,2)", color = "red") +
  facet_wrap(~Parameters, scales = "free_x") +
  theme_bw() +
  labs(x = "Values", y = "% Mean rugosity") +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold", size = 10),
        axis.text.x = element_text(angle = 30, hjust=1))
supp2A
```

<a name = "Diversity_Rugosity"></a>

### Supplemental Figure 2b: 
```{r}
## plot richness and volume to rugosity
rugPlot <- resFric %>%
  rename('%Sp Richness' = NbSpP, '%FE Richness' = NbFEsP, '%FE Volume' = Vol8D) %>% 
  pivot_longer(cols = c('%Sp Richness', '%FE Richness', '%FE Volume'), names_to = "Parameters", values_to = "Values") %>%
  mutate(Parameters = factor(Parameters, levels = c('%Sp Richness', '%FE Richness', '%FE Volume'))) %>% 
  ggplot(aes(x = meanRugosity, y = Values)) +#, color = NN_umolL)) +
  geom_point() +
  geom_smooth(method = "lm", color = "black", formula = "y~poly(x,2)") +
  facet_wrap(~Parameters, scales = "free") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold", size = 10))+
  labs(x = "Mean Rugosity",
       y = "Relative Abundance (%)")
rugPlot

```


```{r, p1param, eval = FALSE, echo = FALSE}
###############################
# MODEL RESIDUALS ~ SGD PARAMETERS
###############################

#check residuals against other parameters
p1param <- resFric %>%
  rename('N+N (umol/L)' = NN_umolL, 'Phosphate (umol/L)' = Phosphate_umolL,
         'Silicate (umol/L)' = Silicate_umolL, 'Temperature (C)' = Temperature) %>%
  select(-TA) %>%
  pivot_longer(cols = c(Salinity:'N+N (umol/L)'), names_to = "Parameters", values_to = "Values") %>%
  ggplot(aes(x = Values, y = resSpp)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x", color = "black") +
  geom_smooth(method = "lm", formula = "y~poly(x,2)", color = "red") +
  facet_wrap(~Parameters, scales = "free_x") +
  theme_bw() +
  labs(x = "Values", y = "% SR (rugosity-normalized)") +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold", size = 10))
p1param
```
```{r, p2param, eval = FALSE, echo = FALSE}
p2param <- resFric %>%
  rename('N+N (umol/L)' = NN_umolL, 'Phosphate (umol/L)' = Phosphate_umolL,
         'Silicate (umol/L)' = Silicate_umolL, 'Temperature (C)' = Temperature) %>%
  select(-TA) %>%
  pivot_longer(cols = c(Salinity:'N+N (umol/L)'), names_to = "Parameters", values_to = "Values") %>%
  ggplot(aes(x = Values, y = resFEp)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x", color = "black") +
  geom_smooth(method = "lm", formula = "y~poly(x,2)", color = "red") +
  facet_wrap(~Parameters, scales = "free_x") +
  theme_bw() +
  labs(x = "Values", y = "% FER (rugosity-normalized)") +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold", size = 10))
p2param
```
```{r, p3param, echo = FALSE, eval = FALSE}
p3param <- resFric %>%
  rename('N+N (umol/L)' = NN_umolL, 'Phosphate (umol/L)' = Phosphate_umolL,
         'Silicate (umol/L)' = Silicate_umolL, 'Temperature (C)' = Temperature) %>%
  select(-TA) %>%
  pivot_longer(cols = c(Salinity:'N+N (umol/L)'), names_to = "Parameters", values_to = "Values") %>%
  ggplot(aes(x = Values, y = resVol)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y~x", color = "black") +
  geom_smooth(method = "lm", formula = "y~poly(x,2)", color = "red") +
  facet_wrap(~Parameters, scales = "free_x") +
  theme_bw() +
  labs(x = "Values", y = "% FEV (rugosity-normalized)") +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(face = "bold", size = 10))
p3param
```




<a name = "CVNutrients"></a>

### Supplemental Figure 3: 

```{r}

###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(ggrepel)
library(patchwork)
library(MuMIn)
library(tidytext)



###############################
# READ IN DATA
###############################
Fric <- read_csv(here("Data", "Sp_FE_Vol.csv"))
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
meta <- read_csv(here("Data", "Full_Metadata.csv"))
chem <- read_csv(here("Data","Biogeochem", "Nutrients_Processed_All.csv")) %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  #filter(CowTagID != "VSEEP") %>%
  select(CowTagID, Parameters, CVSeasonal) %>%
  pivot_wider(names_from = Parameters, values_from = CVSeasonal)
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))


### Join Sp and FE and Vol4D with metadata
resFric <- resFric %>%
  as_tibble() %>%
  left_join(meta) %>%
  filter(CowTagID != "VSEEP" &
           CowTagID != "V13") %>%
  mutate(meanRugosity = 1-meanRugosity) %>%  # instead of lower values indicating higher structure, now high value indicate high structure
  left_join(chem)

```
```{r}
###############################
# VISUALIZATION
###############################

supp3a <- resFric %>% 
  select(CowTagID, Salinity, Phosphate_umolL, Silicate_umolL, NN_umolL) %>% 
  pivot_longer(cols = c(NN_umolL, Phosphate_umolL), names_to = "param", values_to = "values") %>% 
  ggplot(aes(x = Silicate_umolL, y = values)) +
  geom_point(color = "black") +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white")) +
  labs(x = "Silicate (umol/L)",
       y = "CV (umol/L)") +
  facet_wrap(~param, scales = "free_y")

supp3b <- resFric %>% 
  select(CowTagID, Salinity, Phosphate_umolL, Silicate_umolL, NN_umolL) %>% 
  pivot_longer(cols = c(NN_umolL, Phosphate_umolL), names_to = "param", values_to = "values") %>% 
  ggplot(aes(x = Salinity, y = values)) +
  geom_point(color = "black") +
  geom_smooth(method = "lm", color = "black") +
  theme_bw() +
  theme(strip.background = element_rect(fill = "white")) +
  labs(x = "Salinity (psu)",
       y = "CV (umol/L)") +
  facet_wrap(~param, scales = "free_y")

supp3a / supp3b +
  plot_annotation(tag_levels = "A")
```





<a name = "LMFunctionalTraits"></a>

### Supplemental Figure 4: Linear regressions of functional traits along CV Phosphate gradient

```{r}

```





<a name = "FE_Sp_ratio"></a>

### Supplemental Figure 5: Ratio of functional entity richness to species richness along CV Phosphate gardient

```{r}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)




###############################
# READ IN DATA
###############################
meta <- read_csv(here("Data","Full_metadata.csv"))
chem <- read_csv(here("Data","Biogeochem", "Nutrients_Processed_All.csv")) %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari",
         CowTagID != "V13") %>%
  select(CowTagID, Parameters, CVSeasonal) %>%
  pivot_wider(names_from = Parameters, values_from = CVSeasonal)
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv")) %>%
  as_tibble() %>%
  left_join(meta) %>%
  left_join(chem) %>%
  filter(#CowTagID != "VSEEP",
    CowTagID != "V13")


###############################
# PROCESS DATA
###############################

### Calculate Ratios
resFric %>% mutate(FE_SP = NbFEs / NbSp) %>% select(CowTagID,NbFEs, NbSp, FE_SP)



###############################
# VISUALIZE
###############################

### Without seepage point
pRat <- resFric %>%
  filter(CowTagID != "VSEEP") %>%
  ggplot(aes(x = Phosphate_umolL,
             y = NbFEs / NbSp)) +
  geom_point(size = 2.5) +
  geom_smooth(method = "lm", formula = "y~x", color = "black") +
  theme_bw() +
  theme(axis.title.y = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.title.x = element_blank()) +
  theme(panel.grid = element_blank()) +
  labs(y = "FER / SR")

### With seepage point
pRatSeep <- resFric %>%
  ggplot(aes(x = Phosphate_umolL,
             y = NbFEs / NbSp)) +
  geom_point(size = 2.5) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_smooth(method = "lm", formula = "y~x", color = "black") +
  theme_bw() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(size = 12)) +
  theme(panel.grid = element_blank()) +
  labs(y = "FER / SR",
       x = expression("CV Phosphate ("*mu*"mol/L)"))

### Patch
SpFERatio <- (pRat / pRatSeep) +
   plot_annotation(tag_levels = 'A')
```






<a name = "Substrate"></a>

### Supplemental Figure 6: Substrate cover

```{r}
############################
### LOAD LIBRARIES
############################
library(tidyverse)
library(here)
library(PNWColors)



############################
### READ IN DATA
############################
sub <- read_csv(here("Data", "Surveys", "Substrate_2022.csv"))
alpha <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))
chem <- read_csv(here("Data", "Biogeochem", "Nutrients_Processed_All.csv"))


############################
### PROCESS DATA FOR FIGURE
############################
sub <- sub %>% 
  right_join(alpha) %>% 
  select(AlphaTag, LiveCoral:Sand) %>% 
  pivot_longer(cols = c(LiveCoral:Sand), names_to = "substrate", values_to = "values") %>% 
  group_by(AlphaTag) %>% 
  mutate(total = sum(values),
         pcover = values/total*100) %>% 
  select(AlphaTag, substrate, pcover)

chem <- chem %>% 
  right_join(alpha) %>% 
  filter(Season == "Dry") %>% 
  select(AlphaTag, Parameters, CVSeasonal) %>% 
  filter(Parameters == "Phosphate_umolL") %>% 
  arrange(CVSeasonal)
myorder <- chem$AlphaTag

sub <- sub %>% 
  mutate(AlphaTag = factor(AlphaTag, levels = myorder),
         substrate = if_else(substrate == "LiveCoral", "Live Coral", 
                     if_else(substrate == "DeadCoral", "Dead Coral", substrate)))



############################
### VISUALIZATION
############################
mypal <- pnw_palette("Starfish", n=7)[c(3,6,4,7)]

subPlot <- sub %>% 
  ggplot(aes(x = AlphaTag, y = pcover)) +
  geom_col(aes(fill = substrate), position = "stack") +
  scale_fill_manual(values = mypal) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 13)) +
  labs(x = "Survey Locations", y = "% Cover", fill = "Substrate")
```
```{r, eval = FALSE}
ggsave(here("Output", "PaperFigures", "SuppFig5_Substrate.png"), subPlot, device = "png", width = 6, height = 6)
```







```{r, eval = FALSE, echo = FALSE}
### CHECKING STATS ALONG NUTRIENT SGD GRADIENT

#############################
# LOAD LIBRARIES
#############################
library(tidyverse)
library(here)
library(vegan) # nMDS and permanova
library(pairwiseAdonis)




#############################
# READ IN DATA
#############################
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
chem <- read_csv(here("Data","Biogeochem","Nutrients_Processed_All.csv")) 
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))

ab.sgd <- read_csv(here("Data", "Species_Abundances_wide.csv"))
spe_fes.sgd <- as.data.frame(read_csv(here("Data", "Species_FE.csv")))




#############################
# PROCESS DATA
#############################
keepParam <- c("Salinity", "Temperature", "pH", "Phosphate_umolL", "NN_umolL", "Silicate_umolL")

chem <- chem %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  filter(CowTagID != "VSEEP") %>%
  select(CowTagID, Parameters, CVSeasonal) %>% 
  left_join(alphatag) %>% 
  select(-CowTagID) %>% 
  filter(Parameters %in% keepParam)
  

mySi <- chem %>% 
  select(AlphaTag, Parameters,CVSeasonal) %>% 
  filter(Parameters == "Silicate_umolL") %>% 
  pivot_wider(names_from = Parameters, values_from = CVSeasonal)



myPhos <- chem %>% 
  select(AlphaTag, Parameters,CVSeasonal) %>% 
  filter(Parameters == "Phosphate_umolL") %>% 
  pivot_wider(names_from = Parameters, values_from = CVSeasonal) %>% 
  # use factors for nmds?
  mutate(rel = if_else(Phosphate_umolL > 0.16, "High", # D, C, N, H, A
               if_else(Phosphate_umolL < 0.05, "Low", # Q, E, F, B
                      "Moderate")))



#############################
# PARAMETERS ~ PHOSPHATE LM
#############################
modelData <- chem %>% 
  select(AlphaTag, Parameters, CVSeasonal) %>% 
  filter(Parameters != "Phosphate_umolL") %>% 
  left_join(myPhos)

model <- lm(data = modelData, CVSeasonal ~ Phosphate_umolL*Parameters)
model2 <- lm(data = modelData, CVSeasonal ~ poly(Phosphate_umolL,2)*Parameters)
AIC(model,model2)

library(agricolae)
print(HSD.test(model2, "Parameters"))
HSD.test(model2, "Parameters", console = TRUE)
summary(model2)




#############################
# DIVERSITY ~ PHOSPHATE LM
#############################
modelData <- resFric %>% 
  left_join(alphatag) %>% 
  left_join(myPhos) %>% 
  drop_na(Phosphate_umolL) %>% 
  dplyr::select(NbSpP, NbFEsP, Vol8D, resSpp, resFEp, resVol, Phosphate_umolL)
summary(lm(data = modelData, Vol8D ~ poly(Phosphate_umolL,2)))
summary(lm(data = modelData, resVol ~ poly(Phosphate_umolL,2)))
```


```{r, eval = FALSE, echo = FALSE}
### nMDS and perMANOVA

############################
# LOAD LIBRARIES
#############################
library(tidyverse)
library(here)
library(vegan) # nMDS and permanova
library(pairwiseAdonis)




#############################
# READ IN DATA
#############################
# resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
chem <- read_csv(here("Data","Biogeochem","Nutrients_Processed_All.csv"))
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))


# for nMDS and perMANOVA
ab.sgd <- read_csv(here("Data", "Species_Abundances_wide.csv")) %>% filter(CowTagID != "VSEEP")
ab.sgd <- as.data.frame(column_to_rownames(ab.sgd, var = 'CowTagID')) # move tag names to rownames and make data.frame class
spe_fes.sgd <- as.data.frame(read_csv(here("Data", "Species_FE.csv")))

set.seed(7)


#############################
# PROCESS CHEM DATA
#############################
chem <- chem  %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  filter(CowTagID != "VSEEP") %>%
  dplyr::select(CowTagID, Parameters, CVSeasonal) %>%
  pivot_wider(names_from = Parameters, values_from = CVSeasonal) %>% 
  dplyr::select(CowTagID, Phosphate_umolL) %>% 
  mutate(rel = if_else(Phosphate_umolL > 0.16, "High", # D, C, N, H, A
               if_else(Phosphate_umolL < 0.05, "Low", # Q, E, F, B
                      "Moderate")))


# ab.sgd %>% 
#   pivot_longer(cols = Turf:ncol(.), names_to = "Taxa", values_to = "pcover") %>% 
#   left_join(spe_fes.sgd) %>% 
#   left_join(alphatag) %>% 
#   left_join(chem) %>% 
#   arrange(desc(Phosphate_umolL), FE) %>% 
#   group_by(CowTagID, AlphaTag, FE) %>% 
#   mutate(pcover = sum(pcover)) %>% 
#   select(-Taxa) %>% 
#   distinct()
```


# ANOSIM

<a name = "ANOSIM"></a>

### Figure 6: Analysis of Similarity
```{r}
#############################
# LOAD LIBRARIES
#############################
library(tidyverse)
library(here)
library(vegan)
library(patchwork)
# library(geosphere)





#############################
# LOAD DATA
#############################
chem <- read_csv(here("Data","Biogeochem","Nutrients_Processed_All.csv")) %>% 
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  filter(CowTagID != "VSEEP") %>%
  dplyr::select(CowTagID, Parameters, CVSeasonal)

alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))

myorder <- chem %>% 
  filter(Parameters == "Phosphate_umolL") %>% 
  left_join(alphatag) %>% 
  arrange(CVSeasonal)
myorder <- myorder$AlphaTag



ab.sgd <- read_csv(here("Data", "Species_Abundances_wide.csv")) %>% filter(CowTagID != "VSEEP")
ab.sgd <- ab.sgd %>% 
  left_join(alphatag) %>% 
  mutate(AlphaTag = factor(AlphaTag, levels = myorder)) %>% 
  arrange(AlphaTag) %>% 
  dplyr::select(-AlphaTag)

mychem <- chem %>% 
  filter(Parameters == "NN_umolL" |
           Parameters == "Phosphate_umolL" |
           Parameters == "Salinity" |
           Parameters == "Silicate_umolL" |
           Parameters == "Temperature" |
           Parameters == "pH"
           ) %>% 
  pivot_wider(names_from = Parameters, values_from = CVSeasonal) %>% 
  left_join(alphatag) %>% 
  mutate(AlphaTag = factor(AlphaTag, levels = myorder)) %>% 
  arrange(AlphaTag) %>% 
  dplyr::select(-AlphaTag)

# move tag names to rownames and make data.frame class as needed
mychem <- column_to_rownames(mychem,var = "CowTagID")
ab.sgd <- as.data.frame(column_to_rownames(ab.sgd, var = 'CowTagID'))

# color plot by % SR
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv")) %>% 
  filter(CowTagID != "VSEEP") %>% 
  left_join(alphatag) %>% 
  mutate(AlphaTag = factor(AlphaTag, levels = myorder)) %>% 
  arrange(AlphaTag)


set.seed(7)



```
```{r, eval = FALSE}
#############################
# Normalize before scaling
#############################
hist(log(mychem$Salinity + 0.0001)) # left skew before transformation
hist(mychem$Silicate_umolL)
hist(mychem$NN_umolL)
hist(mychem$Phosphate_umolL)
hist(mychem$Temperature)
hist(log(mychem$pH + 0.0001)) # left skew before transformation
```
```{r}
mychem <- mychem %>% 
  mutate(Salinity = log(Salinity + 0.0001),
         pH = log(pH + 0.0001))

```
```{r}
#############################
# ANOSIM - grouped by AlphaTag
#############################

#anosim(ab.sgd, mygroup$rel, distance = "bray", permutations = 9999)




#############################
# ANOSIM - along Phosphate
#############################
# along continuous parameter: Mantel Test

### Now we have to convert these subsets into distance matrices.

#abundance data frame - bray-curtis dissimilarity
dist.abund = vegdist(ab.sgd, method = "bray")

#environmental vector - euclidean distance
# need to scale chem data
dist.chem = dist(scale(x = mychem, scale = T, center = T), method = "euclidean")
#dist.chem = dist(mychem, method = "euclidean")

df.resFric<-as.data.frame(column_to_rownames(resFric, var = 'CowTagID')) %>% 
  select(NbSpP)
dist.var = dist(df.resFric, method = "euclidean") # if I want to color points by resSpp

### Now we can run the mantel command:

#abundance vs environmental 
abund_chemSR = mantel(dist.abund, dist.chem, method = "spearman", permutations = 9999, na.rm = TRUE)
abund_chemSR
```
```{r}
#### The point of this figure will be to visualize the correlation between two corresponding matrices of data. Each point in these pairwise scatter plots will represent the difference between two samples 

# Next, I need to convert these distance matrices (multiple columns) into vectors (one column), and then combine these matrices into one new data frame mat

aa = as.vector(dist.abund)
tt = as.vector(dist.chem)
gg = as.vector(dist.var)

#new data frame with vectorized distance matrices
matSR = data.frame(aa,tt,gg)


#First is the pairwise comparison of community dissimilarity and differences in temperature:

#abundance vs temperature
mmSR = ggplot(matSR, aes(y = aa, x = tt)) + 
    geom_point(size = 3, alpha = 0.5, shape = 21, aes(fill = gg)) + 
    labs(x = expression(Delta*" SGD"), y = "Bray-Curtis Dissimilarity", fill = "% SR Dissimilarity") + #fill = expression("PO"[4]^"3-")) + 
    theme( axis.text.x = element_text(face = "bold",colour = "black", size = 12), 
           axis.text.y = element_text(face = "bold", size = 11, colour = "black"), 
           axis.title= element_text(face = "bold", size = 14, colour = "black"), 
           panel.background = element_blank(), 
           panel.border = element_rect(fill = NA, colour = "black"),
           legend.position = "top",
           legend.text = element_text(size = 10, face = "bold"),
           legend.title = element_text(size = 11, face = "bold")) +
    scale_fill_continuous(high = "purple", low = "lightpink")
mmSR



```

```{r}
####### SAME TEST BUT NOW WITH FE
#############################
# LOAD DATA
#############################
spe_fes.sgd <- as.data.frame(read_csv(here("Data", "Species_FE.csv")))

ab.sgd <- read_csv(here("Data", "Species_Abundances_wide.csv")) %>% filter(CowTagID != "VSEEP")

# join species abundance with FE to get Fe abundance
ab.sgd <- ab.sgd %>% 
  pivot_longer(cols = Turf:ncol(.), names_to = "Taxa", values_to = "pCover") %>% 
  left_join(spe_fes.sgd) %>% 
  group_by(CowTagID, FE) %>% 
  summarise(pCover = sum(pCover)) %>% 
  pivot_wider(names_from = FE, values_from = pCover)

# order cowtagid's
ab.sgd <- ab.sgd %>% 
  left_join(alphatag) %>% 
  mutate(AlphaTag = factor(AlphaTag, levels = myorder)) %>% 
  arrange(AlphaTag) %>% 
  dplyr::select(-AlphaTag)

# environmental matrix for changing SGD
mychem # same as above

 # move tag names to rownames and make data.frame class
ab.sgd <- as.data.frame(column_to_rownames(ab.sgd, var = 'CowTagID'))
#mychem <- as.data.frame(column_to_rownames(mychem, var = 'CowTagID')) 


set.seed(7)




#############################
# ANOSIM - grouped by AlphaTag
#############################

# ref: anosim(m_com, pc$Time, distance = "bray", permutations = 9999)
#anosim(ab.sgd, mygroup$rel, distance = "bray", permutations = 9999)




#############################
# ANOSIM - along Phosphate
#############################
# along continuous parameter: Mantel Test

### Now we have to convert these subsets into distance matrices.

#abundance data frame - bray-curtis dissimilarity
dist.abund = vegdist(ab.sgd, method = "bray")

#environmental vector - euclidean distance
# need to scale chem data
#dist.chem = dist(scale(x = mychem, scale = T, center = T), method = "euclidean")
#dist.chem = dist(mychem, method = "euclidean")


# third vector variable
df.resFric <- as.data.frame(column_to_rownames(resFric, 'CowTagID')) %>% select(NbFEs)
dist.var = dist(df.resFric, method = "euclidean")

### Now we can run the mantel command:

#abundance vs environmental matrix
# spearman correlation is a nonparametric test, not relying on any particular pattern assemptions
abund_chemFER = mantel(dist.abund, dist.chem, method = "spearman", permutations = 9999, na.rm = TRUE)
abund_chemFER


```

### Pairwise scatterplot
```{r}
#### The point of this figure will be to visualize the correlation between two corresponding matrices of data. Each point in these pairwise scatter plots will represent the difference between two samples 

# Next, I need to convert these distance matrices (multiple columns) into vectors (one column), and then combine these matrices into one new data frame mat

aa = as.vector(dist.abund)
tt = as.vector(dist.chem)
gg = as.vector(dist.var)

#new data frame with vectorized distance matrices
matFER = data.frame(aa,tt,gg)


#First is the pairwise comparison of community dissimilarity and differences in temperature:

#abundance vs temperature
mmFER = ggplot(matFER, aes(y = aa, x = tt)) + 
    geom_point(size = 3, alpha = 0.5, shape = 21, aes(fill = gg)) + 
    labs(x = expression(Delta*" SGD"), y = "Bray-Curtis Dissimilarity", fill = "% FER Dissimilarity") + #fill = expression("PO"[4]^"3-")) + 
    theme( axis.text.x = element_text(face = "bold",colour = "black", size = 12), 
           axis.text.y = element_text(face = "bold", size = 11, colour = "black"), 
           axis.title= element_text(face = "bold", size = 14, colour = "black"), 
           panel.background = element_blank(), 
           panel.border = element_rect(fill = NA, colour = "black"),
           legend.position = "top",
           legend.text = element_text(size = 10, face = "bold"),
           legend.title = element_text(size = 11, face = "bold")) +
    scale_fill_continuous(high = "navy", low = "skyblue") +
  geom_smooth(method = "lm", color= "black")
mmFER

```
```{r}
## PATCH PLOTS
Bray_Curtis_Plot <- mmSR / mmFER +
  plot_annotation(tag_levels = 'A')

Bray_Curtis_Plot
```
```{r, eval = FALSE}
ggsave(here("Output", "PaperFigures", "Fig6_Composiiton_SGD.png"), Bray_Curtis_Plot, device = "png", height = 6, width = 6)
```









### Species along SGD gradient

```{r}
#############################
# LOAD LIBRARIES
#############################
library(tidyverse)
library(here)





#############################
# READ IN DATA
#############################
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
chem <- read_csv(here("Data","Biogeochem","Nutrients_Processed_All.csv")) 
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))

ab.sgd <- read_csv(here("Data", "Species_Abundances_wide.csv"))
spe_fes.sgd <- as.data.frame(read_csv(here("Data", "Species_FE.csv")))




#############################
# PROCESS DATA
#############################
keepParam <- c("Salinity", "Temperature", "pH", "Phosphate_umolL", "NN_umolL", "Silicate_umolL")

chem <- chem %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  filter(CowTagID != "VSEEP") %>%
  dplyr::select(CowTagID, Parameters, CVSeasonal) %>% 
  left_join(alphatag) %>% 
  dplyr::select(-CowTagID) %>% 
  filter(Parameters %in% keepParam)
  

#############################
# ABUNDANCES
#############################
phos <- chem %>% filter(Parameters == "Phosphate_umolL") %>% 
  rename(phosphate = CVSeasonal) %>% 
  select(-Parameters)

data <- ab.sgd %>% 
  left_join(alphatag) %>% 
  left_join(phos) %>% 
  drop_na(phosphate) %>% 
  pivot_longer(cols = Turf:'Caulerpa racemosa', names_to = "Taxa", values_to = "pcover")

# get infrequent species out of here
myspecies <- data %>% 
  filter(pcover>0) %>% 
  dplyr::count(Taxa) %>% 
  arrange(desc(n)) %>% # now filter based on species presence
  filter(n > 10)
myspecies <- myspecies$Taxa


#############################
# VISUALIZE
#############################
data %>% 
  filter(Taxa %in% myspecies) %>% 
  ggplot(aes(x = phosphate, y = pcover)) +
  geom_point() +
  theme_bw() +
  facet_wrap(~Taxa, scales = "free_y")

```
```{r}
#############################
# MODELING
#############################
modTable <- tibble(Taxa = as.character(),
                     Reg_Type = as.character(), # linear or nonlinear
                     R2 = as.numeric(),
                     pVal.P = as.numeric()
                   )


myDep <- unique((data %>% filter(Taxa %in% myspecies))$Taxa)
myDep <- unique(data$Taxa)
# mydata <- resFric %>%
  # select(CowTagID,NbSpP, NbFEsP, Vol8D, resSpp, resFEp, resVol, Salinity, Temperature, pH, Phosphate_umolL, Silicate_umolL, NN_umolL, meanRugosity)


for(i in myDep){
  taxa <- as.character(i)
  #k <- which(myDep == i) # use as multiplier for list
  mydat <- data %>% 
    filter(Taxa == taxa)

    model1R <- lm(pcover ~ phosphate, data = mydat)
    subdata1R <- as_tibble(cbind(taxa)) %>%
      mutate(Reg_Type = "Linear",
             R2 = summary(model1R)$r.squared,
             pVal.P = summary(model1R)$coefficients[8]
             )


    model2R <- lm(pcover ~ poly(phosphate,2), data = mydat)
    subdata2R <- as_tibble(cbind(taxa)) %>%
      mutate(Reg_Type = "Polynomial",
             R2 = summary(model2R)$r.squared,
             pVal.P = summary(model2R)$coefficients[12]
             )


    modTable <- modTable %>%
      rbind(subdata1R) 

  
}

modTable %>% 
  filter(pVal.P < 0.06)


summary(lm(data = data %>% filter(Taxa == "Turf"),
   pcover ~ poly(phosphate,2)))
  
```



# FE along SGD gradient

```{r}
#############################
# LOAD LIBRARIES
#############################
library(tidyverse)
library(here)





#############################
# READ IN DATA
#############################
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
chem <- read_csv(here("Data","Biogeochem","Nutrients_Processed_All.csv")) 
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))

ab.sgd <- read_csv(here("Data", "Species_Abundances_wide.csv"))
spe_fes.sgd <- as.data.frame(read_csv(here("Data", "Species_FE.csv")))




#############################
# PROCESS DATA
#############################
keepParam <- c("Salinity", "Temperature", "pH", "Phosphate_umolL", "NN_umolL", "Silicate_umolL")

chem <- chem %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari", CowTagID != "V13") %>%
  filter(CowTagID != "VSEEP") %>%
  dplyr::select(CowTagID, Parameters, CVSeasonal) %>% 
  left_join(alphatag) %>% 
  dplyr::select(-CowTagID) %>% 
  filter(Parameters %in% keepParam)
  

#############################
# ABUNDANCES
#############################
phos <- chem %>% filter(Parameters == "Phosphate_umolL") %>% 
  rename(phosphate = CVSeasonal) %>% 
  dplyr::select(-Parameters)

data <- ab.sgd %>%  
  left_join(alphatag) %>% 
  left_join(phos) %>% 
  drop_na(phosphate) %>% 
  pivot_longer(cols = Turf:'Caulerpa racemosa', names_to = "Taxa", values_to = "pcover") %>%
  left_join(spe_fes.sgd) %>%
  group_by(CowTagID, FE) %>% 
  mutate(pcover = sum(pcover)) %>% 
  dplyr::select(-Taxa) %>% 
  distinct() %>% 
  ungroup()

# get infrequent species out of here
myspecies <- data %>% 
  filter(pcover>0) %>% 
  dplyr::count(FE) %>% 
  arrange(desc(n)) %>%   # now filter based on species presence
  filter(n > 1)
myspecies <- myspecies$FE

data <- data %>% 
  filter(pcover > 0)

#############################
# VISUALIZE
#############################
data %>% 
  filter(FE %in% myspecies) %>% 
  ggplot(aes(x = phosphate, y = pcover)) +
  geom_point() +
  theme_bw() +
  facet_wrap(~FE, scales = "free_y")

```
```{r}
#############################
# MODELING
#############################
modTable <- tibble(FE = as.character(),
                     Reg_Type = as.character(), # linear or nonlinear
                     R2 = as.numeric(),
                     pVal.P = as.numeric()
                   )


myDep <- unique((data %>% filter(FE %in% myspecies))$FE)
#myDep <- unique(data$FE)
# mydata <- resFric %>%
  # select(CowTagID,NbSpP, NbFEsP, Vol8D, resSpp, resFEp, resVol, Salinity, Temperature, pH, Phosphate_umolL, Silicate_umolL, NN_umolL, meanRugosity)


for(i in myDep){
  fe <- as.character(i)
  #k <- which(myDep == i) # use as multiplier for list
  mydat <- data %>% 
    filter(FE == fe)

    model1R <- lm(pcover ~ phosphate, data = mydat)
    subdata1R <- as_tibble(cbind(fe)) %>%
      mutate(Reg_Type = "Linear",
             R2 = summary(model1R)$r.squared,
             pVal.P = summary(model1R)$coefficients[8]
             )


    model2R <- lm(pcover ~ poly(phosphate,2), data = mydat)
    subdata2R <- as_tibble(cbind(fe)) %>%
      mutate(Reg_Type = "Polynomial",
             R2 = summary(model2R)$r.squared,
             pVal.P = summary(model2R)$coefficients[12]
             )


    modTable <- modTable %>%
      rbind(subdata1R) 

  
}

modTable
```


<a name = "slides_species_selection"></a>
```{r, eval = FALSE, echo = FALSE}
###############################
# LOAD LIBRARIES
###############################
library(tidyverse)
library(here)
library(vegan)
library(pairwiseAdonis)

###############################
# READ IN DATA
###############################
alphatag <- read_csv(here("Data","CowTag_to_AlphaTag.csv")) %>% mutate(AlphaTag = if_else(CowTagID == "VSEEP", "A-Seep",AlphaTag))
traits <- read_csv(here("Data", "Surveys","Distinct_Taxa.csv"))
comp <- read_csv(here("Data", "Surveys", "Species_Composition_2022.csv"))
meta <- read_csv(here("Data", "Full_Metadata.csv"))
chem <- read_csv(here("Data","Biogeochem", "Nutrients_Processed_All.csv"))
resFric <- read_csv(here("Data", "Sp_FE_Vol_res.csv"))
# PCoA axes of traits
fd.coord.sgd <- read.csv(here("Data","FE_4D_coord_dmb.csv"), row.names = 1) # class data.frame
# FE with trait groups
fes_traits.sgd <- read_csv(here("Data", "Distinct_FE.csv"))
# species abundances (%) wide format
myspecies <- read_csv(here("Data", "Species_Abundances_wide.csv"))
# species and functional entities
species_entities <- read_csv(here("Data", "Species_FE.csv"))


###############################
# FE ABUNDANCES
###############################

meta <- meta %>% # fill in seep rugosity value
  mutate(meanRugosity = if_else(CowTagID == "VSEEP", 0.97, meanRugosity))

chem <- chem %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari",
         CowTagID != "V13") %>%
  dplyr::select(CowTagID, Parameters, CVSeasonal) %>%
  pivot_wider(names_from = Parameters, values_from = CVSeasonal)
redchem <- chem %>% dplyr::select(CowTagID, Phosphate_umolL, NN_umolL)

comp <- comp %>%
  filter(Location == "Varari") %>%  # only analyze varari for now
  filter(CowTagID != "V13")


# pivot myspecies longer
ab.conditions.sgd2 <- myspecies %>%
  pivot_longer(names_to = "Taxa", values_to = "pCover", cols = 2:ncol(myspecies)) %>%
  left_join(spe_fes.sgd) %>%
  group_by(CowTagID, FE) %>%
  summarise(pCover = sum(pCover)) %>%
  ungroup()



# set SGD influence factor as low, moderate, high levels

VarResFric <- resFric %>%
  left_join(alphatag) %>%
  dplyr::select(AlphaTag, Vol8D)
low <- VarResFric %>%
  filter(AlphaTag == "B" | AlphaTag == "F" | AlphaTag == "E" | AlphaTag == "Q") %>%
  mutate(Varcat = "Low")
high <- VarResFric %>%
  filter(AlphaTag == "D" | AlphaTag == "C" | AlphaTag == "N" | AlphaTag == "H" | AlphaTag == "A-Seep") %>%
  mutate(Varcat = "High")
LH <- rbind(low,high)

LH <- LH %>% dplyr::select(-Vol8D)
permData <- rownames_to_column(as.data.frame(fd.coord.sgd), var = "FE") %>%
  full_join(ab.conditions.sgd2) %>%
  dplyr::select(FE, CowTagID, pCover) %>%
  left_join(alphatag) %>%
  filter(AlphaTag != "A-Seep") %>%
  dplyr::select(-CowTagID) %>% # using alpha tag as the identifier
  pivot_wider(names_from = FE, values_from = pCover) %>%
  left_join(LH) %>%
  mutate(Varcat = if_else(is.na(Varcat), "Moderate", Varcat)) %>%
  relocate(Varcat, .after = AlphaTag) %>%
  dplyr::select(-AlphaTag)


permanovamodel<-adonis2(permData[,-1]~Varcat, permData, permutations = 999,method="bray")
permanovamodel

#assume that the dispersion among data is the same in each group. We can test with assumption with a PermDisp test:
disper<-vegdist(permData[,-1])
betadisper(disper, permData$Varcat)
#Look at the Average distance to median...these numbers should be reasonably similar
#A rule of thumb is that one number should not be twice as high as any other

#An option for doing post-hoc pairwise comparisons in R
library(pairwiseAdonis)
pairwise.adonis(permData[-1], permData$Varcat, perm=999)


```





### Taxa Abundances

```{r, Supp.Abundance.Plot}
############################
### LOAD LIBRARIES
############################

library(tidyverse)
library(here)
library(PNWColors)


############################
### READ IN DATA
############################

traits <- read_csv(here("Data", "Surveys","Distinct_Taxa.csv"))
myspecies <- read_csv(here("Data", "Surveys", "Species_Composition_2022.csv"))
alphatag <- read_csv(here("Data", "CowTag_to_AlphaTag.csv"))

#meta <- read_csv(here("Data", "Full_Metadata.csv"))
chem <- read_csv(here("Data","Biogeochem", "Nutrients_Processed_All.csv"))


############################
### CLEAN DATA
############################

chem <- chem %>%
  filter(Season == "Dry") %>%
  filter(Location == "Varari",
         #CowTagID != "VSEEP" &
         CowTagID != "V13") %>%
  select(CowTagID, Parameters, CVSeasonal) %>%
  pivot_wider(names_from = Parameters, values_from = CVSeasonal) %>%
  select(CowTagID, Phosphate_umolL) %>%
  left_join(alphatag)

AlphaOrder <- chem %>%
  arrange(Phosphate_umolL)
AlphaOrder <- AlphaOrder$AlphaTag

myspecies <- myspecies %>%
  filter(Location == "Varari", # only analyze varari for now
         CowTagID != "V13") %>%
  left_join(chem) %>%
  mutate(AlphaTag = factor(AlphaTag, levels = AlphaOrder))

traits <- traits %>%
  select(Taxa, Taxon_Group, Morph2, Calc, ER)


############################
### ANALYZE SPECIES PRESENCE
############################
mypal <- pnw_palette("Bay", n = 13)

# calculate percent cover of species including substrate points
# to get actual abundance of species along gradient
topSp <- myspecies %>%
  select(CowTagID:SpeciesCounts, AlphaTag) %>% # remove unnecessary columns
  select(-Date) %>%
  group_by(CowTagID) %>%
  mutate(totalCounts = sum(SpeciesCounts)) %>%
  group_by(CowTagID, Taxa) %>%
  mutate(SpeciesCounts = sum(SpeciesCounts)) %>% # add all of same species together
  distinct() %>% # remove duplicates
  ungroup() %>%
  mutate(pCover = SpeciesCounts / totalCounts*100) %>%
  distinct() %>%
  filter(Taxa != "Sand" &
           Taxa != "Bare Rock" &
           Taxa != "Rubble")

# put in zero values
zerotopSp <- topSp %>%
  pivot_wider(names_from = Taxa, values_from = pCover) %>%
  mutate_at(.vars = 5:ncol(.), .funs= ~if_else(is.na(.),0,.)) %>%
  pivot_longer(cols = 5:ncol(.), names_to = "Taxa", values_to = "pCover") %>% 
    mutate(Taxa = if_else(Taxa == "Crustose Corallines", "CCA", Taxa))

# relative abundance across sites, zeros included
Supp.Abundance.Plot <- zerotopSp %>%
  # adds line break into string for graphing
  separate(Taxa, into = c("t1","t2"), sep = " ",) %>%
  mutate(t3 = "\n",
         t2 = if_else(is.na(t2),"",t2)) %>%
  unite(t1,t3,t2, col = "Taxa", sep = "") %>%
  ggplot(aes(x = AlphaTag, y = pCover)) +
  geom_col(color = "black", fill = "grey",
           position = "dodge", show.legend = FALSE) +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        strip.background = element_rect(fill = "white"),
        strip.text = element_text(size = 8),
        axis.title = element_text(size = 13),
        axis.text.x = element_text(size = 6),
        axis.text.y = element_text(size = 8)) +
  labs(x = "Survey Location",
       y = "Relative Abundance (%)") +
  scale_y_continuous(n.breaks = 3) +
  facet_wrap(~Taxa, scales = "free_y", ncol = 5)

Supp.Abundance.Plot
```
```{r, eval = FALSE}
ggsave(here("Output", "PaperFigures", "Supp.Abundance.Plot.png"), Supp.Abundance.Plot, device = "png", width = 7, height = 11)
```
```{r, eval = FALSE, echo = FALSE}
#### running some stats on these species
modData <- topSp %>% 
  select(-CowTagID, -SpeciesCounts, -totalCounts) %>% 
  left_join(chem)
  
summary(lm(data = modData,
           pCover~Taxa))
summary(lm(data = modData,
   pCover ~ poly(Phosphate_umolL,2)*Taxa))

summary(lm(data = modData %>% filter(),
   pCover ~ poly(Phosphate_umolL,2)*Taxa))

model<-lm(data = modData %>% filter(Taxa != "Porites rus" & Taxa != "Turbinaria ornata" &
                                       Taxa != "Turf" & Taxa != "Pocillopora acuta"),
   pCover ~ Taxa)
summary(model)
library(agricolae)
HSD.test(model, "Taxa", console = T)



zerotopSp  %>% filter(Taxa == "Porites rus" | Taxa == "Turbinaria ornata" |
                      Taxa == "Turf" | Taxa == "Pocillopora acuta" |
                      Taxa == "CCA" | Taxa == "Dictyota bartayresiana") %>% 
  ggplot(aes(x = AlphaTag,y = pCover)) +
  geom_point() +
  facet_wrap(~Taxa, scales = "free_y")
```







